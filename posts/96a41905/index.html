<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>SpringCloud | xw的妙妙屋</title><meta name="author" content="xw"><meta name="copyright" content="xw"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. 认识微服务 本章从单体架构的优缺点切入，分析大型项目采用单体架构的问题，以及微服务架构的解决思路。 1.1 单体架构 单体架构（monolithic structure）：顾名思义，整个项目中所有功能模块都在同一个工程中开发；部署时需对所有模块一起编译、打包；架构设计和开发模式非常简单。  当项目规模较小时，单体架构上手快、部署运维方便，因此早期小型项目多采用这种模式。 但随着业务规模扩大、">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud">
<meta property="og:url" content="https://www.xwybq.top/posts/96a41905/index.html">
<meta property="og:site_name" content="xw的妙妙屋">
<meta property="og:description" content="1. 认识微服务 本章从单体架构的优缺点切入，分析大型项目采用单体架构的问题，以及微服务架构的解决思路。 1.1 单体架构 单体架构（monolithic structure）：顾名思义，整个项目中所有功能模块都在同一个工程中开发；部署时需对所有模块一起编译、打包；架构设计和开发模式非常简单。  当项目规模较小时，单体架构上手快、部署运维方便，因此早期小型项目多采用这种模式。 但随着业务规模扩大、">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png">
<meta property="article:published_time" content="2025-09-21T02:59:21.000Z">
<meta property="article:modified_time" content="2025-09-22T04:42:35.535Z">
<meta property="article:author" content="xw">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "SpringCloud",
  "url": "https://www.xwybq.top/posts/96a41905/",
  "image": "https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png",
  "datePublished": "2025-09-21T02:59:21.000Z",
  "dateModified": "2025-09-22T04:42:35.535Z",
  "author": [
    {
      "@type": "Person",
      "name": "xw",
      "url": "https://www.xwybq.top"
    }
  ]
}</script><link rel="shortcut icon" href="/image/%E4%B8%89%E8%8A%B1%E7%8C%AB.png"><link rel="canonical" href="https://www.xwybq.top/posts/96a41905/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'SpringCloud',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/styles/main.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script><link rel="stylesheet" href="/css/daliyuer.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/twikoo_beauty.css"><link rel="stylesheet" href="/css/beauty.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="/css/custom_code.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="xw的妙妙屋" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/image/headshot.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fa-brands fa-youtube"></i><span> 番剧</span></a></div><div class="menus_item"><a class="site-page" href="/steamgames/"><i class="fa-fw fa-brands fa-steam"></i><span> 游戏库</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-solid fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/image/test.gif" alt="Logo"><span class="site-name">xw的妙妙屋</span></a><a class="nav-page-title" href="/"><span class="site-name">SpringCloud</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="weather"><div id="tp-weather-widget"></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/bangumis/"><i class="fa-fw fa-brands fa-youtube"></i><span> 番剧</span></a></div><div class="menus_item"><a class="site-page" href="/steamgames/"><i class="fa-fw fa-brands fa-steam"></i><span> 游戏库</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/gallery/"><i class="fa-fw fas fa-solid fa-image"></i><span> 相册</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div><div id="nav-right"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><!-- span= ' ' + _p('search.title')--></span></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">SpringCloud</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-21T02:59:21.000Z" title="发表于 2025-09-21 10:59:21">2025-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-22T04:42:35.535Z" title="更新于 2025-09-22 12:42:35">2025-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>1. 认识微服务</h1>
<p>本章从单体架构的优缺点切入，分析大型项目采用单体架构的问题，以及微服务架构的解决思路。</p>
<h3 id="1-1-单体架构">1.1 单体架构</h3>
<p>单体架构（monolithic structure）：顾名思义，整个项目中所有功能模块都在<strong>同一个工程</strong>中开发；部署时需对所有模块一起编译、打包；架构设计和开发模式非常简单。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf72dc1ec9f.png" alt=""></p>
<p>当项目规模较小时，单体架构上手快、部署运维方便，因此早期小型项目多采用这种模式。</p>
<p>但随着业务规模扩大、团队人员增加，单体架构的问题逐渐凸显：</p>
<ul>
<li><strong>团队协作成本高</strong>：数十人协作同一项目时，模块间代码边界模糊，分支合并易陷入 “冲突泥潭”。</li>
<li><strong>系统发布效率低</strong>：任何模块变更都需发布<strong>整个系统</strong>，模块间制约多，一次发布可能耗时数十分钟甚至数小时。</li>
<li><strong>系统可用性差</strong>：所有功能作为一个服务部署，相互影响大。热点功能耗尽资源时，会导致其他服务不可用。</li>
</ul>
<h4 id="单体架构可用性问题演示（以黑马商城为例）">单体架构可用性问题演示（以黑马商城为例）</h4>
<p>为直观展示单体架构的可用性问题，对黑马商城的 <code>hm-service</code> 模块做如下改造与测试：</p>
<ol>
<li>
<p><strong>修改代码模拟耗时</strong>：修改 <code>com.hmall.controller.HelloController</code> 中的 <code>hello</code> 方法，模拟接口执行耗时。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf730d29dc5.png" alt=""></p>
</li>
<li>
<p><strong>启动项目与接口测试</strong>：启动项目后，有两个无需登录即可访问的接口：</p>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/hi">http://localhost:8080/hi</a></p>
</li>
<li>
<p><a target="_blank" rel="noopener" href="http://localhost:8080/search/list">http://localhost:8080/search/list</a></p>
<p>测试发现<code>/search/list</code>接口响应正常（耗时约 30 毫秒）。</p>
</li>
</ul>
</li>
<li>
<p><strong>模拟热点接口高并发</strong>：假设 <code>/hi</code> 是<strong>热点接口</strong>，使用 Jemeter 模拟 500 个用户并发访问。课前资料提供了 Jemeter 测试脚本。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf73b6dd172.png" alt=""></p>
</li>
<li>
<p><strong>导入 Jemeter 并执行测试：</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf74551b3ee.png" alt=""></p>
<p>由于 <code>/hi</code> 接口执行耗时（500 毫秒），服务端处理能力有限，请求会逐渐积压，最终耗尽 Tomcat 资源。此时，原本正常的 <code>/search/list</code> 接口也会被拖慢。</p>
</li>
<li>
<p><strong>验证影响</strong>：启动 Jemeter 测试后，在浏览器访问 <code>http://localhost:8080/search/list</code>，会发现响应速度极慢。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7489e6e5b.png" alt=""></p>
<p>若进一步提高 <code>/hi</code> 的并发，<code>/search/list</code> 的响应会更慢，甚至超时。</p>
</li>
</ol>
<p>可见，单体架构的可用性较差，功能间相互影响大。即使做<strong>水平扩展</strong>（增加机器），热点接口仍会占用资源，无法从根本上解决扩展性问题。</p>
<h3 id="1-2-微服务">1.2 微服务</h3>
<p>微服务架构的核心是<strong>服务化</strong>：将单体架构中的功能模块从单体应用中拆分出来，<strong>独立部署为多个服务</strong>。同时需满足以下特点：</p>
<ul>
<li><strong>单一职责</strong>：一个微服务负责一部分业务功能，且核心数据不依赖于其他模块。</li>
<li><strong>团队自治</strong>：每个微服务有独立的开发、测试、发布、运维团队，人员规模不超过 10 人（“2 张披萨能喂饱” 原则）。</li>
<li><strong>服务自治</strong>：每个微服务独立打包部署，访问自己的数据库，并做好<strong>服务隔离</strong>，避免影响其他服务。</li>
</ul>
<h4 id="微服务拆分示例（黑马商城）">微服务拆分示例（黑马商城）</h4>
<p>黑马商城可将<strong>商品、用户、购物车、交易</strong>等模块拆分，由不同团队独立开发和部署：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf750acb4a2.png" alt=""></p>
<h4 id="微服务对单体问题的解决">微服务对单体问题的解决</h4>
<p>单体架构的问题在微服务架构下得到改善：</p>
<ul>
<li><strong>团队协作成本高</strong>：服务拆分后，每个服务代码量减少，参与开发的人员通常 1~3 名，协作成本大幅降低。</li>
<li><strong>系统发布效率低</strong>：每个服务独立部署，模块变更时仅需打包部署对应服务。</li>
<li><strong>系统可用性差</strong>：服务独立部署且隔离，使用专属服务器资源，不会相互影响。</li>
</ul>
<p>微服务架构是<strong>分布式架构的最佳实践</strong>，适合大型互联网项目开发。但拆分后也会面临新问题（如跨服务业务处理、页面请求路由、服务隔离等），后续会逐步讲解。</p>
<h3 id="1-3-SpringCloud">1.3 SpringCloud</h3>
<p>微服务拆分后，跨服务协作、路由、隔离等问题需要专门的组件解决。<strong>SpringCloud</strong>是 Java 领域最全面的微服务组件集合，依托 SpringBoot 的自动装配能力，大幅降低了项目搭建和组件使用的成本，是中小型企业实现微服务开发的优选方案。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf757308070.png" alt=""></p>
<p>SpringCloud 官网：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud#overview">https://spring.io/projects/spring-cloud#overview</a></p>
<h4 id="SpringCloud-与-SpringBoot-版本对应">SpringCloud 与 SpringBoot 版本对应</h4>
<p>目前 Spring Cloud 最新版本为 <strong>2025.0.x（代号 Northfields）</strong>，依赖 JDK 17，对应 Spring Boot 3.5.x 版本。Spring Cloud 各版本与 Spring Boot 的适配遵循严格的兼容性规范，且部分早期版本已正式停止支持（End of Life, EOL）。企业中常根据稳定性需求选择次新版本（如 2024.0.x、2023.0.x）进行落地。</p>
<table>
<thead>
<tr>
<th>Spring Cloud 版本（Release Train）</th>
<th>Spring Boot 版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>2025.0.x（Northfields）</td>
<td>3.5.x</td>
<td>最新版本，依赖 JDK 17</td>
</tr>
<tr>
<td>2024.0.x（Moorgate）</td>
<td>3.4.x</td>
<td>次新版本，稳定性已过验证</td>
</tr>
<tr>
<td>2023.0.x（Leyton）</td>
<td>3.3.x、3.2.x</td>
<td>适配 Spring Boot 3.x 主流版本</td>
</tr>
<tr>
<td>2022.0.x（Kilburn）</td>
<td>3.0.x、3.1.x（从 2022.0.3 版本开始适配）</td>
<td>早期 Spring Boot 3.x 适配版本</td>
</tr>
<tr>
<td>2021.0.x（Jubilee）</td>
<td>2.6.x、2.7.x（从 2021.0.3 版本开始适配）</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>2020.0.x（Ilford）</td>
<td>2.4.x、2.5.x（从 2020.0.3 版本开始适配）</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>Hoxton</td>
<td>2.2.x、2.3.x（从 SR5 版本开始适配）</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>Greenwich</td>
<td>2.1.x</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>Finchley</td>
<td>2.0.x</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>Edgware</td>
<td>1.5.x</td>
<td>已停止支持（EOL）</td>
</tr>
<tr>
<td>Dalston</td>
<td>1.5.x</td>
<td>已停止支持（EOL）</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：根据 Spring Cloud 官方说明，<strong>Dalston、Edgware、Finchley、Greenwich、2020.0.x（Ilford）、2021.0.x（Jubilee）、2022.0.x（Kilburn）均已停止支持</strong>，不再提供 bug 修复及安全更新，建议避免在新系统中使用，并逐步将旧系统迁移至 2023.0.x 及以上版本。</p>
</blockquote>
<p>本文使用的是 <strong>Spring Cloud 2021.0.x + Spring Boot 2.7.x</strong>。</p>
<p>此外，<code>SpringCloudAlibaba</code> 也已成为 SpringCloud 生态的一部分，课程中会使用其部分组件。</p>
<h4 id="父工程依赖配置（黑马商城）">父工程依赖配置（黑马商城）</h4>
<p>在黑马商城的父工程 <code>hmall</code> 中，已配置 SpringCloud 和 SpringCloudAlibaba 的依赖：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7804175fc.png" alt=""></p>
<p>这样，后续使用 SpringCloud 或 SpringCloudAlibaba 组件时，无需单独指定版本。</p>
<h1>2. 微服务拆分</h1>
<p>接下来，我们将黑马商城单体项目拆分为微服务项目，并解决过程中出现的问题。</p>
<h3 id="2-1-熟悉黑马商城">2.1 熟悉黑马商城</h3>
<p>首先需熟悉黑马商城项目的基本结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf794d363e0.png" alt=""></p>
<p>可直接启动项目测试效果，但需修改数据库连接参数（在 <code>application-local.yaml</code> 中）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hm:</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span> <span class="hljs-comment"># 修改为你Ubuntu系统所在虚拟机的IP地址</span><br>    <span class="hljs-attr">pw:</span> <span class="hljs-number">123</span> <span class="hljs-comment"># 修改为Docker中MySQL的密码</span><br></code></pre></td></tr></table></figure>
<p>同时需配置启动项激活 <code>local</code> 环境：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf797f76153.png" alt=""></p>
<h4 id="2-1-1-登录业务">2.1.1 登录业务</h4>
<p>登录业务流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf79b1b939d.png" alt=""></p>
<p>服务端入口为 <code>com.hmall.controller.UserController</code> 中的 <code>login</code> 方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf79cdae134.png" alt=""></p>
<h4 id="2-1-2-搜索商品">2.1.2 搜索商品</h4>
<p>在首页搜索框输入关键字并点击搜索，进入搜索列表页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf79eb1035d.png" alt=""></p>
<p>该页面调用接口 <code>/search/list</code>，服务端入口为 <code>com.hmall.controller.SearchController</code> 中的 <code>search</code> 方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7a8263a39.png" alt="image"></p>
<h4 id="2-1-3-购物车业务">2.1.3 购物车业务</h4>
<ul>
<li>
<p>加入购物车：在商品列表点击 “加入购物车” 按钮，商品加入购物车：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7a0e05531.png" alt="image"></p>
</li>
<li>
<p>购物车列表页：加入成功后进入购物车列表页，可查看、修改、删除购物车商品：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7aa04b42d.png" alt="image"></p>
</li>
</ul>
<p>相关功能入口为 <code>com.hmall.controller.CartController</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7b7170f04.png" alt="image"></p>
<p>查询购物车列表时，需判断商品最新价格和状态，因此要查询商品信息，业务流程：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7b9cb4b99.png" alt="image"></p>
<h4 id="2-1-4-下单业务">2.1.4 下单业务</h4>
<ul>
<li>
<p>订单结算页：在购物车页面点击 “结算” 按钮，进入订单结算页面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7bc65a74d.png" alt="image"></p>
</li>
<li>
<p>提交订单：点击 “提交订单”，服务端执行 3 件事：</p>
<ul>
<li>创建新订单</li>
<li>扣减商品库存</li>
<li>清理购物车商品</li>
</ul>
</li>
</ul>
<p>业务入口为 <code>com.hmall.controller.OrderController</code> 中的 <code>createOrder</code> 方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7bf502d70.png" alt="image"></p>
<h4 id="2-1-5-支付业务">2.1.5 支付业务</h4>
<p>下单后跳转到支付页面（目前仅支持余额支付）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7c2103136.png" alt="image"></p>
<p>选择 “余额支付” 后，服务端会创建支付流水单并返回流水单号；用户输入密码点击 “确认支付” 时，服务端执行：</p>
<ul>
<li>校验用户密码</li>
<li>扣减余额</li>
<li>修改支付流水状态</li>
<li>修改交易订单状态</li>
</ul>
<p>请求入口为 <code>com.hmall.controller.PayController</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7c6033cb3.png" alt="image"></p>
<h3 id="2-2-服务拆分原则">2.2 服务拆分原则</h3>
<p>服务拆分需重点考虑两个问题：</p>
<ul>
<li>什么时候拆？</li>
<li>如何拆？</li>
</ul>
<h4 id="2-2-1-什么时候拆">2.2.1 什么时候拆</h4>
<ul>
<li><strong>初创项目</strong>：优先验证可行性，建议采用<strong>单体架构</strong>。原因是：
<ul>
<li>开发成本低，可快速产出产品投入市场验证</li>
<li>若产品不符合市场需求，损失较小</li>
<li>缺点：后期拆分可能面临代码耦合问题（前易后难）</li>
</ul>
</li>
<li><strong>大型项目</strong>：立项时目标明确，建议直接采用<strong>微服务架构</strong>。原因是：
<ul>
<li>长远考虑，避免后期拆分的麻烦</li>
<li>缺点：前期投入人力和时间成本高（前难后易）</li>
</ul>
</li>
</ul>
<h4 id="2-2-2-怎么拆">2.2.2 怎么拆</h4>
<p>微服务拆分的核心目标是<strong>高内聚、低耦合</strong>：</p>
<ul>
<li><strong>高内聚</strong>：每个微服务职责单一，内部业务关联度高、完整性强。修改业务时应尽量仅涉及当前服务，降低变更成本。</li>
<li><strong>低耦合</strong>：服务功能相对独立，减少对其他服务的依赖；若有依赖，需保证接口稳定性（外观不变）。例如：订单服务需商品数据时，应调用商品服务的接口，而非直接访问商品数据库，避免数据耦合。</li>
</ul>
<h5 id="拆分方式">拆分方式</h5>
<ol>
<li><strong>纵向拆分</strong>：按功能模块拆分（如黑马商城的用户、订单、购物车等模块），提高服务内聚性。</li>
<li><strong>横向拆分</strong>：抽取各模块的公共业务为通用服务（如消息发送、风控管理），提高复用性，降低耦合。</li>
</ol>
<p>黑马商城按纵向拆分可分为：</p>
<ul>
<li>用户服务</li>
<li>商品服务</li>
<li>订单服务</li>
<li>购物车服务</li>
<li>支付服务</li>
</ul>
<h3 id="2-3-拆分购物车、商品服务">2.3 拆分购物车、商品服务</h3>
<p>微服务项目的两种工程结构：</p>
<ul>
<li><strong>完全解耦</strong>：每个服务独立工程（可跨语言），耦合度低但管理麻烦。</li>
<li><strong>Maven 聚合</strong>：父工程下的多个 Module，集中管理（适合授课），但编译时间较长。</li>
</ul>
<p>课程采用<strong>Maven 聚合工程</strong>，基于黑马商城父工程 <code>hmall</code> 拆分服务（父工程已预设 SpringBoot、SpringCloud 依赖版本）。</p>
<h4 id="2-3-1-商品服务（item-service）">2.3.1 商品服务（item-service）</h4>
<ol>
<li>
<p><strong>创建 Module</strong>：在 <code>hmall</code> 父工程中创建 Maven 模块，命名为 <code>item-service</code>，JDK 版本为 11。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7deba5c00.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7dfe5d052.png" alt="image"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7e17a2cdc.png" alt="image"></p>
</li>
<li>
<p><strong>配置依赖（pom.xml）</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hmall<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>item-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 公共模块 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hm-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Web --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 数据库 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- MyBatis-Plus --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 单元测试 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>编写启动类</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7e50e177a.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.item;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@MapperScan(&quot;com.hmall.item.mapper&quot;)</span> <span class="hljs-comment">// 扫描Mapper接口</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ItemApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>配置文件</strong>：从 <code>hm-service</code> 拷贝配置文件，修改 <code>application.yaml</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7f2fc673b.png" alt="image"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span> <span class="hljs-comment"># 商品服务端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">item-service</span> <span class="hljs-comment"># 服务名称</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://$&#123;hm.db.host&#125;:3306/hm-item?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">$&#123;hm.db.pw&#125;</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">default-enum-type-handler:</span> <span class="hljs-string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">update-strategy:</span> <span class="hljs-string">not_null</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">com.hmall:</span> <span class="hljs-string">debug</span><br>  <span class="hljs-attr">pattern:</span><br>    <span class="hljs-attr">dateformat:</span> <span class="hljs-string">HH:mm:ss:SSS</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span><br><span class="hljs-attr">knife4j:</span> <span class="hljs-comment"># Swagger文档配置</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">openapi:</span><br>    <span class="hljs-attr">title:</span> <span class="hljs-string">商品服务接口文档</span><br>    <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;商品服务接口文档信息&quot;</span><br>    <span class="hljs-attr">email:</span> <span class="hljs-string">zhanghuyi@itcast.cn</span><br>    <span class="hljs-attr">concat:</span> <span class="hljs-string">虎哥</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">https://www.itcast.cn</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0.0</span><br>    <span class="hljs-attr">group:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">group-name:</span> <span class="hljs-string">default</span><br>        <span class="hljs-attr">api-rule:</span> <span class="hljs-string">package</span><br>        <span class="hljs-attr">api-rule-resources:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">com.hmall.item.controller</span><br></code></pre></td></tr></table></figure>
<p>（<code>application-dev.yaml</code> 和 <code>application-local.yaml</code> 直接拷贝，修改数据库连接参数为 Ubuntu 虚拟机的 IP 和密码）</p>
</li>
<li>
<p><strong>拷贝商品相关代码</strong>：将 <code>hm-service</code> 中与商品管理相关的代码（实体类、Controller、Service、Mapper 等）拷贝到 <code>item-service</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf7fe333cfd.png" alt="image"></p>
</li>
<li>
<p><strong>修改代码依赖</strong>：调整 <code>ItemServiceImpl</code> 中 <code>deductStock</code> 方法的 <code>ItemMapper</code> 包路径（因包结构变化）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf806278dcd.png" alt="image"></p>
</li>
<li>
<p><strong>导入数据库表</strong>：在 Docker 的 MySQL 中执行课前资料提供的 SQL 文件，创建 <code>hm-item</code> 数据库（每个微服务独立数据库）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8091d4ac8.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf80f3d0be6.png" alt="image"></p>
</li>
<li>
<p><strong>启动与测试</strong>：</p>
<ul>
<li>
<p>配置启动项，激活<code>local</code>环境：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf816542aa8.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf81882e36c.png" alt="image"></p>
</li>
<li>
<p>启动 <code>ItemApplication</code>，访问 Swagger 文档：<a target="_blank" rel="noopener" href="http://localhost:8081/doc.html">http://localhost:8081/doc.html</a></p>
</li>
<li>
<p>测试 “根据 id 批量查询商品” 接口，参数：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tex">100002672302,100002624500,100002533430<br></code></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf820a3d387.png" alt="image"></p>
</li>
</ul>
</li>
</ol>
<h4 id="2-3-2-购物车服务（cart-service）">2.3.2 购物车服务（cart-service）</h4>
<ol>
<li>
<p><strong>创建 Module</strong>：在 <code>hmall</code> 父工程中创建 Maven 模块，命名为 <code>cart-service</code>。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf821c5e9b7.png" alt="image"></p>
</li>
<li>
<p><strong>配置依赖（pom.xml）</strong>：与 <code>item-service</code> 类似，仅模块名为 <code>cart-service</code>。</p>
</li>
<li>
<p><strong>编写启动类</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.cart;<br><br><span class="hljs-keyword">import</span> org.mybatis.spring.annotation.MapperScan;<br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@MapperScan(&quot;com.hmall.cart.mapper&quot;)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CartApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(CartApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>配置文件</strong>：拷贝 <code>item-service</code> 的配置文件，修改 <code>application.yaml</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span> <span class="hljs-comment"># 购物车服务端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cart-service</span> <span class="hljs-comment"># 服务名称</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://$&#123;hm.db.host&#125;:3306/hm-cart?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br><span class="hljs-comment"># 其他配置基本与item-service一致，只需要把item改成cart即可，略...</span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>拷贝购物车相关代码</strong>：将 <code>hm-service</code> 中与购物车相关的代码拷贝到 <code>cart-service</code>，最终结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf82a040d69.png" alt="image"></p>
</li>
<li>
<p><strong>修改代码</strong>：在 <code>CartServiceImpl</code> 中处理依赖问题：</p>
<ul>
<li>暂时写死用户 ID（因登录功能未拆分，可以写成1L）</li>
<li>注释查询商品信息的代码（需调用商品服务，待后续解决，暂时先把<code>handleCartItems</code>函数内容注释掉）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf82c3b32e7.png" alt="image"></p>
</li>
<li>
<p><strong>导入数据库表</strong>：执行课前资料的 SQL 文件，创建 <code>hm-cart</code> 数据库及 <code>cart</code> 表。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf83398aafb.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8351574a8.png" alt="image"></p>
</li>
<li>
<p><strong>启动与测试</strong>：</p>
<ul>
<li>
<p>配置启动项激活<code>local</code>环境：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8380bc9bf.png" alt="image"></p>
</li>
<li>
<p>启动 <code>CartApplication</code>，访问 Swagger 文档：<code>http://localhost:8082/doc.html</code></p>
</li>
<li>
<p>测试 “查询我的购物车列表” 接口，结果中商品相关字段为空（因代码注释）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf839c4c62f.png" alt="image"></p>
</li>
</ul>
</li>
</ol>
<h4 id="问题：如何在-cart-service-中查询-item-service-的商品信息？">问题：如何在 cart-service 中查询 item-service 的商品信息？</h4>
<p>当前购物车服务查询商品信息的代码被注释，需解决<strong>服务间通信</strong>问题，后续将介绍微服务远程调用方案。</p>
<h3 id="2-4-服务调用">2.4 服务调用</h3>
<p>在拆分购物车服务时，发现<strong>购物车查询需依赖商品服务的商品信息</strong>，但商品逻辑已迁移至 <code>item-service</code>，导致购物车数据不完整。因此需将<strong>本地方法调用</strong>改造为<strong>跨微服务的远程调用（RPC，Remote Procedure Call）</strong>。</p>
<h4 id="2-4-1-远程调用流程">2.4.1 远程调用流程</h4>
<p>购物车查询商品的流程变为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8bbdc52a9.png" alt="image"></p>
<p>代码中需改造的核心步骤：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8c7d3dc4a.png" alt="image"></p>
<h4 id="2-4-2-如何实现跨服务-HTTP-调用？">2.4.2 如何实现跨服务 HTTP 调用？</h4>
<p>前端通过浏览器发送 HTTP 请求可实现 “远程查询服务端数据”（如 Swagger 测试商品接口 <code>http://localhost:8081/items</code>）。同理，若在 <code>cart-service</code> 中模拟 “浏览器发送 HTTP 请求”，即可调用 <code>item-service</code> 的接口。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8cae591c5.png" alt="image"></p>
<h5 id="2-4-2-1-RestTemplate（Spring-HTTP-请求工具）">2.4.2.1 RestTemplate（Spring HTTP 请求工具）</h5>
<p>Spring 提供 <code>RestTemplate</code> 简化 HTTP 请求发送，支持 GET、POST、PUT、DELETE 等多种请求类型。</p>
<p><strong><code>RestTemplate</code> 说明</strong>：</p>
<blockquote>
<p>同步 HTTP 客户端，基于底层 HTTP 库（如 JDK <code>HttpURLConnection</code>、Apache HttpComponents 等）封装模板方法。支持常见 HTTP 场景，且可配置为共享组件（启动时初始化，避免并发修改）。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8ce47030f.png" alt="image"></p>
<h5 id="2-4-2-2-注册-RestTemplate-为-Spring-Bean">2.4.2.2 注册 RestTemplate 为 Spring Bean</h5>
<p>在 <code>cart-service</code> 中创建配置类，将 <code>RestTemplate</code> 注册到 Spring 容器：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8d0e72929.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.cart.config;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteCallConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-4-3-远程调用实战（购物车调用商品服务）">2.4.3 远程调用实战（购物车调用商品服务）</h4>
<p>修改 <code>cart-service</code> 中 <code>CartServiceImpl</code> 的 <code>handleCartItems</code> 方法，通过 <code>RestTemplate</code> 发送 HTTP 请求到 <code>item-service</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8d6b41153.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCartItems</span><span class="hljs-params">(List&lt;CartVO&gt; vos)</span> &#123;<br>    <span class="hljs-comment">// 1. 获取商品ID集合</span><br>    Set&lt;Long&gt; itemIds = vos.stream().map(CartVO::getItemId).collect(Collectors.toSet());<br>    <br>    <span class="hljs-comment">// 2. 发送HTTP GET请求到item-service的商品查询接口</span><br>    ResponseEntity&lt;List&lt;ItemDTO&gt;&gt; response = restTemplate.exchange(<br>            <span class="hljs-string">&quot;http://localhost:8081/items?ids=&#123;ids&#125;&quot;</span>, <span class="hljs-comment">// 请求路径（带路径参数）</span><br>            HttpMethod.GET,                         <span class="hljs-comment">// 请求方法</span><br>            <span class="hljs-literal">null</span>,                                   <span class="hljs-comment">// 请求体（GET无请求体）</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterizedTypeReference</span>&lt;List&lt;ItemDTO&gt;&gt;() &#123;&#125;, <span class="hljs-comment">// 响应类型（泛型列表）</span><br>            Map.of(<span class="hljs-string">&quot;ids&quot;</span>, CollUtil.join(itemIds, <span class="hljs-string">&quot;,&quot;</span>)) <span class="hljs-comment">// 路径参数（商品ID拼接为字符串）</span><br>    );<br>    <br>    <span class="hljs-comment">// 3. 解析响应</span><br>    <span class="hljs-keyword">if</span> (!response.getStatusCode().is2xxSuccessful()) &#123;<br>        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 请求失败，直接返回</span><br>    &#125;<br>    List&lt;ItemDTO&gt; items = response.getBody();<br>    <span class="hljs-keyword">if</span> (CollUtils.isEmpty(items)) &#123;<br>        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 商品列表为空，直接返回</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 4. 转换为“商品ID -&gt; 商品DTO”的Map，方便后续填充购物车VO</span><br>    Map&lt;Long, ItemDTO&gt; itemMap = items.stream()<br>            .collect(Collectors.toMap(ItemDTO::getId, Function.identity()));<br>    <br>    <span class="hljs-comment">// 5. 填充购物车VO的商品信息</span><br>    <span class="hljs-keyword">for</span> (CartVO v : vos) &#123;<br>        <span class="hljs-type">ItemDTO</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> itemMap.get(v.getItemId());<br>        <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) &#123;<br>            v.setNewPrice(item.getPrice());<br>            v.setStatus(item.getStatus());<br>            v.setStock(item.getStock());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-4-4-测试远程调用">2.4.4 测试远程调用</h4>
<p>重启 <code>cart-service</code>，再次测试 “查询我的购物车列表” 接口，商品相关数据（价格、库存、状态等）可正常返回。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8d832aca6.png" alt="image"></p>
<h3 id="2-5-总结">2.5 总结</h3>
<h4 id="微服务拆分时机">微服务拆分时机</h4>
<ul>
<li><strong>创业型公司</strong>：先以<strong>单体架构</strong>快速迭代，验证市场模型；业务跑通后，再随规模扩大拆分微服务（前易后难）。</li>
<li><strong>大型企业</strong>：项目初期直接搭建<strong>微服务架构</strong>（资源充足，前难后易）。</li>
</ul>
<h4 id="微服务拆分原则">微服务拆分原则</h4>
<ul>
<li>核心目标：<strong>高内聚、低耦合</strong>。</li>
<li>拆分方式：
<ul>
<li><strong>纵向拆分</strong>：按业务功能模块拆分（如用户、订单、商品）。</li>
<li><strong>横向拆分</strong>：抽取通用业务为独立服务（如消息、风控），提高复用性。</li>
</ul>
</li>
</ul>
<h4 id="微服务远程调用（RPC）">微服务远程调用（RPC）</h4>
<p>微服务间远程调用称为 RPC，常见实现方式：</p>
<ul>
<li><strong>基于 HTTP 协议</strong>：不关心服务提供者技术，仅依赖 HTTP 接口，符合微服务解耦需求。</li>
<li><strong>基于 Dubbo 协议</strong>：高性能二进制协议，需服务提供者和消费者遵循 Dubbo 规范。</li>
</ul>
<p>课程采用 <strong>HTTP 方式</strong>，通过 Spring <code>RestTemplate</code> 实现：</p>
<ol>
<li>注册 <code>RestTemplate</code> 到 Spring 容器。</li>
<li>调用 <code>RestTemplate</code> 方法发送请求（如 <code>getForObject</code>、<code>postForObject</code>、<code>exchange</code> 等）。</li>
</ol>
<h1>3. 服务注册和发现</h1>
<p>上一章实现了微服务拆分及跨服务远程调用，但手动发送 HTTP 请求的方式存在问题。当商品服务（<code>item-service</code>）多实例部署时，会面临<strong>地址管理、调用选择、故障处理、动态扩展</strong>等挑战。</p>
<p>试想一下，假如商品微服务被调用较多，为了应对更高的并发，我们进行了多实例部署，如图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf8f83f1ca3.png" alt="image"></p>
<p>此时，每个<code>item-service</code>的实例其IP或端口不同，问题来了：</p>
<ul>
<li>item-service这么多实例，cart-service如何知道每一个实例的地址？</li>
<li>http请求要写url地址，<code>cart-service</code>服务到底该调用哪个实例呢？</li>
<li>如果在运行过程中，某一个<code>item-service</code>实例宕机，<code>cart-service</code>依然在调用该怎么办？</li>
<li>如果并发太高，<code>item-service</code>临时多部署了N台实例，<code>cart-service</code>如何知道新实例的地址？</li>
</ul>
<p>为解决这些问题，需引入<strong>注册中心</strong>。</p>
<h3 id="3-1-注册中心原理">3.1 注册中心原理</h3>
<p>微服务远程调用涉及两个角色：</p>
<ul>
<li><strong>服务提供者</strong>：提供接口供其他服务访问（如 <code>item-service</code>）。</li>
<li><strong>服务消费者</strong>：调用其他服务的接口（如 <code>cart-service</code>）。</li>
</ul>
<p>注册中心是管理服务地址的核心组件，三者关系如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf900b4b6fb.png" alt="image"></p>
<p><strong>核心流程</strong>：</p>
<ol>
<li><strong>服务注册</strong>：服务启动时，将自身信息（服务名、IP、端口）注册到注册中心。</li>
<li><strong>服务订阅</strong>：消费者从注册中心获取目标服务的实例列表。</li>
<li><strong>负载均衡</strong>：消费者从实例列表中选择一个实例发起调用。</li>
<li><strong>动态更新：</strong>
<ul>
<li>服务提供者定期发送<strong>心跳</strong>到注册中心，报告健康状态。</li>
<li>注册中心若长时间未收到心跳，将剔除该实例。</li>
<li>新实例启动时自动注册，注册中心会将变更通知消费者，更新其本地实例列表。</li>
</ul>
</li>
</ol>
<h3 id="3-2-Nacos-注册中心">3.2 Nacos 注册中心</h3>
<p>国内常用的注册中心框架有 Eureka、Nacos、Consul 等。课程选择<strong>Nacos</strong>（Alibaba 出品），原因是中文文档丰富，且兼具配置管理功能。</p>
<p>Nacos 官网：<a target="_blank" rel="noopener" href="https://nacos.io/">https://nacos.io/</a></p>
<h4 id="3-2-1-部署-Nacos（基于-Docker）">3.2.1 部署 Nacos（基于 Docker）</h4>
<ol>
<li>
<p><strong>准备 MySQL 数据库</strong>：</p>
<ul>
<li>将课前资料中的 Nacos 初始化 SQL 文件导入 Docker 的 MySQL 容器。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf91e89e3d9.png" alt="image"></p>
<ul>
<li>最终生成的表结构：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf921ad4f3c.png" alt="image"></p>
</li>
<li>
<p><strong>配置 Nacos 环境变量</strong>：</p>
<ul>
<li>找到课前资料的<code>nacos</code>文件夹，修改<code>nacos/custom.env</code>中的 MySQL 地址为虚拟机 IP：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf926d0972e.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf927eec7f0.png" alt="image"></p>
</li>
<li>
<p><strong>上传并部署 Nacos</strong>：</p>
<ul>
<li>
<p>将 <code>nacos</code> 目录上传至 Ubuntu 虚拟机的 <code>/root</code> 目录。</p>
</li>
<li>
<p>执行 Docker 命令启动 Nacos：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> docker run -d \<br>--name nacos \<br>--env-file ./nacos/custom.env \<br>-p 8848:8848 \<br>-p 9848:9848 \<br>-p 9849:9849 \<br>--restart=always \<br>nacos/nacos-server:v2.1.0-slim<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><strong>访问 Nacos 控制台</strong>：</p>
<ul>
<li>地址：<code>http://虚拟机IP:8848/nacos/</code>（替换为实际 IP）。</li>
<li>登录账号密码均为<code>nacos</code>：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf92d5637e4.png" alt="image"></p>
</li>
</ol>
<h3 id="3-3-服务注册（以item-service为例）">3.3 服务注册（以<code>item-service</code>为例）</h3>
<p>将服务注册到 Nacos 的步骤：</p>
<ul>
<li>引入依赖</li>
<li>配置Nacos地址</li>
<li>重启</li>
</ul>
<h4 id="3-3-1-引入依赖">3.3.1 引入依赖</h4>
<p>在 <code>item-service</code> 的 <code>pom.xml</code> 中添加 Nacos 注册依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Nacos服务注册发现 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="3-3-2-配置-Nacos-地址">3.3.2 配置 Nacos 地址</h4>
<p>在 <code>item-service</code> 的 <code>application.yaml</code> 中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">item-service</span> <span class="hljs-comment"># 服务名称（必须唯一，用于服务发现）</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># Nacos地址（替换为实际虚拟机IP）</span><br></code></pre></td></tr></table></figure>
<h4 id="3-3-3-启动多实例并验证">3.3.3 启动多实例并验证</h4>
<ol>
<li>
<p><strong>配置多实例</strong>：</p>
<ul>
<li>
<p>为<code>item-service</code>新增启动项，修改端口（如 8083）避免冲突：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf932e312ca.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf932e9ce3f.png" alt="image"></p>
</li>
</ul>
</li>
<li>
<p><strong>启动实例</strong>：</p>
<ul>
<li>启动两个 <code>item-service</code> 实例（端口 8081 和 8083）。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf934861540.png" alt="image"></p>
</li>
<li>
<p><strong>验证注册结果</strong>：</p>
<ul>
<li>登录 Nacos 控制台，在 “服务列表” 中查看<code>item-service</code>：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf93746f4a1.png" alt="image"></p>
<ul>
<li>点击 “详情” 可查看两个实例的 IP 和端口：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9384d4ea4.png" alt="image"></p>
</li>
</ol>
<h3 id="3-4-服务发现（以cart-service为例）">3.4 服务发现（以<code>cart-service</code>为例）</h3>
<p>服务消费者通过 Nacos 获取服务实例列表并调用的步骤：</p>
<ul>
<li>引入依赖</li>
<li>配置Nacos地址</li>
<li>发现并调用服务</li>
</ul>
<h4 id="3-4-1-引入依赖">3.4.1 引入依赖</h4>
<p>在 <code>cart-service</code> 的 <code>pom.xml</code> 中添加依赖（包含服务注册和发现功能）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Nacos服务注册发现 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- SpringCloud负载均衡 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>（注：负载均衡依赖用于从多实例中选择一个进行调用）</p>
<h4 id="3-4-2-配置-Nacos-地址">3.4.2 配置 Nacos 地址</h4>
<p>在 <code>cart-service</code> 的 <code>application.yaml</code> 中添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># Nacos地址（替换为实际虚拟机IP）</span><br></code></pre></td></tr></table></figure>
<h4 id="3-4-3-发现并调用服务">3.4.3 发现并调用服务</h4>
<ol>
<li>
<p><strong>注入<code>DiscoveryClient</code></strong>：SpringCloud 自动装配的 <code>DiscoveryClient</code> 可用于获取服务实例列表：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DiscoveryClient discoveryClient;<br></code></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf942ec7108.png" alt="image"></p>
</li>
<li>
<p><strong>修改远程调用逻辑</strong>：从 Nacos 获取 <code>item-service</code> 的实例列表，通过负载均衡（如随机算法）选择一个实例调用：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf94759d47b.png" alt="image"></p>
</li>
<li>
<p><strong>测试验证</strong>：启动 <code>cart-service</code>，通过 Swagger 测试购物车查询接口，可正常获取商品数据，且调用会随机分配到 <code>item-service</code> 的两个实例。</p>
</li>
</ol>
<h3 id="总结">总结</h3>
<ul>
<li><strong>注册中心作用</strong>：解决服务地址管理、动态扩缩容、故障自动剔除等问题。</li>
<li><strong>Nacos 优势</strong>：中文支持好，兼具服务注册发现和配置管理功能。</li>
<li><strong>核心流程</strong>：服务注册（启动时上报地址）→ 服务发现（消费者订阅实例列表）→ 负载均衡（选择实例调用）→ 动态更新（基于心跳和通知）。</li>
</ul>
<h1>4. OpenFeign</h1>
<p>上一章通过 Nacos 实现服务治理，用<code>RestTemplate</code>实现远程调用，但存在<strong>代码复杂、调用体验不统一</strong>的问题（需手动处理服务发现、负载均衡、HTTP 请求构建）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9562b4a8a.png" alt="image"></p>
<p>OpenFeign 可通过<strong>声明式注解</strong>简化远程调用，让其像本地方法调用一样便捷。</p>
<h2 id="4-1-快速入门">4.1 快速入门</h2>
<p>以<code>cart-service</code>调用<code>item-service</code>的商品查询接口为例，演示 OpenFeign 的使用。</p>
<h3 id="4-1-1-引入依赖">4.1.1 引入依赖</h3>
<p>在<code>cart-service</code>的<code>pom.xml</code>中添加 OpenFeign 及负载均衡依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- OpenFeign 核心依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 负载均衡依赖（OpenFeign调用需配合负载均衡） --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="4-1-2-启用-OpenFeign">4.1.2 启用 OpenFeign</h3>
<p>在<code>cart-service</code>的启动类<code>CartApplication</code>上添加<code>@EnableFeignClients</code>注解，开启 OpenFeign 功能：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf959f33fa2.png" alt="image"></p>
<h3 id="4-1-3-编写-Feign-客户端">4.1.3 编写 Feign 客户端</h3>
<p>定义接口，通过 SpringMVC 注解声明远程调用的核心参数（请求方式、路径、参数、返回值），OpenFeign 会自动生成实现类。</p>
<p>在<code>cart-service</code>中创建<code>ItemClient</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.cart.client;<br><br><span class="hljs-keyword">import</span> com.hmall.cart.domain.dto.ItemDTO;<br><span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@FeignClient(&quot;item-service&quot;)</span> <span class="hljs-comment">// 声明服务名称（对应Nacos中的服务名）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemClient</span> &#123;<br><br>    <span class="hljs-comment">// 注解与item-service的Controller接口保持一致</span><br>    <span class="hljs-meta">@GetMapping(&quot;/items&quot;)</span> <span class="hljs-comment">// 请求方式+路径</span><br>    List&lt;ItemDTO&gt; <span class="hljs-title function_">queryItemByIds</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;ids&quot;)</span> Collection&lt;Long&gt; ids)</span>; <span class="hljs-comment">// 请求参数+返回值类型</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="4-1-4-使用-Feign-客户端">4.1.4 使用 Feign 客户端</h3>
<p>在<code>CartServiceImpl</code>中注入<code>ItemClient</code>，直接调用接口方法（无需手动处理服务发现、HTTP 请求）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf978fbd98d.png" alt="image"></p>
<p><strong>优势</strong>：OpenFeign 自动完成「服务发现→负载均衡→HTTP 请求发送→响应解析」全流程，代码简洁且与本地调用体验一致。</p>
<h2 id="4-2-连接池优化">4.2 连接池优化</h2>
<p>Feign 底层依赖 HTTP 客户端实现，默认使用<code>HttpURLConnection</code>（无连接池，性能差）。推荐替换为<strong>支持连接池</strong>的<code>OKHttp</code>或<code>Apache HttpClient</code>，提升并发性能。</p>
<h3 id="4-2-1-引入-OKHttp-依赖">4.2.1 引入 OKHttp 依赖</h3>
<p>在<code>cart-service</code>的<code>pom.xml</code>中添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Feign-OKHttp 依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="4-2-2-开启连接池">4.2.2 开启连接池</h3>
<p>在<code>cart-service</code>的<code>application.yaml</code>中配置启用 OKHttp：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">okhttp:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启OKHttp连接池</span><br></code></pre></td></tr></table></figure>
<h3 id="4-2-3-验证连接池生效">4.2.3 验证连接池生效</h3>
<p>通过断点调试验证底层客户端是否切换为 OKHttp：</p>
<ol>
<li>在<code>org.springframework.cloud.openfeign.loadbalancer.FeignBlockingLoadBalancerClient</code>的<code>execute</code>方法处打断点。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf97e7aec5d.png" alt="image"></p>
<ol>
<li>以 Debug 模式启动<code>cart-service</code>，调用购物车查询接口，进入断点。</li>
<li>观察<code>client</code>对象类型，确认是<code>OkHttpClient</code>。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9844f124b.png" alt="image"></p>
<h2 id="4-3-最佳实践（Feign-客户端抽取）">4.3 最佳实践（Feign 客户端抽取）</h2>
<p>多个服务（如<code>cart-service</code>、<code>trade-service</code>）可能需要调用同一服务（如<code>item-service</code>）的接口，若每个服务都重复定义 Feign 客户端，会导致<strong>代码冗余</strong>。解决方式是将 Feign 客户端抽取到公共模块。</p>
<h3 id="4-3-1-思路分析">4.3.1 思路分析</h3>
<p>两种抽取方案对比：</p>
<table>
<thead>
<tr>
<th>方案</th>
<th>实现方式</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>方案 1：公共模块抽取</td>
<td>抽取到独立的<code>hm-api</code>模块</td>
<td>结构清晰，抽取简单</td>
<td>服务间耦合度较高</td>
</tr>
<tr>
<td>方案 2：服务内抽取</td>
<td>每个服务单独抽取 API 模块</td>
<td>耦合度低</td>
<td>结构复杂，维护成本高</td>
</tr>
</tbody>
</table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf98a7d689d.png" alt="image"></p>
<p>课程采用<strong>方案 1</strong>（适合现有项目结构）。</p>
<h3 id="4-3-2-创建公共-API-模块（hm-api）">4.3.2 创建公共 API 模块（hm-api）</h3>
<ol>
<li>
<p><strong>创建 Module</strong>：在<code>hmall</code>父工程下创建<code>hm-api</code>模块。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf98c5a9daa.png" alt="image"></p>
</li>
<li>
<p><strong>配置依赖（pom.xml）</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hmall<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hm-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- OpenFeign 核心依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 负载均衡依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Swagger注解依赖（接口文档相关） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.swagger<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>swagger-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>拷贝 Feign 客户端及 DTO</strong>：将<code>cart-service</code>中的<code>ItemClient</code>和<code>ItemDTO</code>拷贝到<code>hm-api</code>模块，最终结构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf98df89a93.png" alt="image"></p>
</li>
</ol>
<h3 id="4-3-3-服务引入公共模块">4.3.3 服务引入公共模块</h3>
<ol>
<li>
<p><strong>引入依赖</strong>：在<code>cart-service</code>的<code>pom.xml</code>中添加<code>hm-api</code>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入公共API模块 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hm-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>删除冗余代码</strong>：删除<code>cart-service</code>中原有<code>ItemClient</code>和<code>ItemDTO</code>。</p>
</li>
<li>
<p><strong>解决扫描问题</strong>：启动<code>cart-service</code>会报错 ——<code>ItemClient</code>位于<code>com.hmall.api.client</code>包，而启动类扫描范围是<code>com.hmall.cart</code>，无法识别 Feign 客户端。</p>
<p>两种解决方式：</p>
<ul>
<li><strong>方式 1：指定扫描包</strong>（推荐，适用于多个 Feign 客户端）：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9ab46e1c8.png" alt="image"></p>
<ul>
<li><strong>方式 2：指定 Feign 客户端类</strong>（适用于少量客户端）：</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9ac4659c8.png" alt="image"></p>
</li>
</ol>
<h2 id="4-4-日志配置">4.4 日志配置</h2>
<p>OpenFeign 的日志输出需满足两个条件：</p>
<ol>
<li>Feign 客户端所在包的日志级别为<code>DEBUG</code>。</li>
<li>配置 Feign 的日志级别（默认<code>NONE</code>，不输出日志）。</li>
</ol>
<h3 id="4-4-1-Feign-日志级别">4.4.1 Feign 日志级别</h3>
<table>
<thead>
<tr>
<th>级别</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>NONE</td>
<td>不记录任何日志（默认）</td>
</tr>
<tr>
<td>BASIC</td>
<td>记录请求方法、URL、响应状态码、执行时间</td>
</tr>
<tr>
<td>HEADERS</td>
<td>在 BASIC 基础上，增加请求 / 响应头信息</td>
</tr>
<tr>
<td>FULL</td>
<td>记录完整请求 / 响应（头、体、元数据）</td>
</tr>
</tbody>
</table>
<h3 id="4-4-2-配置日志级别">4.4.2 配置日志级别</h3>
<ol>
<li>
<p><strong>定义日志配置类</strong>：在<code>hm-api</code>模块中创建配置类：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cf9afc0d92b.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.api.config;<br><br><span class="hljs-keyword">import</span> feign.Logger;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFeignConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Logger.Level <span class="hljs-title function_">feignLogLevel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Logger.Level.FULL; <span class="hljs-comment">// 配置为FULL级别</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>生效配置</strong>：</p>
<ul>
<li>
<p><strong>局部生效</strong>（仅对指定 FeignClient 生效）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(</span><br><span class="hljs-meta">    value = &quot;item-service&quot;, </span><br><span class="hljs-meta">    configuration = DefaultFeignConfig.class // 绑定配置类</span><br><span class="hljs-meta">)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemClient</span> &#123; ... &#125;<br></code></pre></td></tr></table></figure>
</li>
<li>
<p><strong>全局生效</strong>（对所有 FeignClient 生效）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(</span><br><span class="hljs-meta">    basePackages = &quot;com.hmall.api.client&quot;,</span><br><span class="hljs-meta">    defaultConfiguration = DefaultFeignConfig.class // 全局配置</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CartApplication</span> &#123; ... &#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p><strong>配置包日志级别</strong>：在<code>cart-service</code>的<code>application.yaml</code>中添加：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">com.hmall.api.client:</span> <span class="hljs-string">debug</span> <span class="hljs-comment"># Feign客户端所在包的日志级别为DEBUG</span><br></code></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-4-3-日志示例（FULL-级别）">4.4.3 日志示例（FULL 级别）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">17:35:32:148 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] ---&gt; GET http://item-service/items?ids=100000006163 HTTP/1.1<br>17:35:32:148 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] ---&gt; END HTTP (0-byte body)<br>17:35:32:278 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] &lt;--- HTTP/1.1 200  (127ms)<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] connection: keep-alive<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] content-type: application/json<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] date: Fri, 26 May 2023 09:35:32 GMT<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] keep-alive: timeout=60<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] transfer-encoding: chunked<br>17:35:32:279 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] <br>17:35:32:280 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] [&#123;&quot;id&quot;:100000006163,&quot;name&quot;:&quot;巴布豆(BOBDOG)柔薄悦动婴儿拉拉裤XXL码80片(15kg以上)&quot;,&quot;price&quot;:67100,&quot;stock&quot;:10000,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t23998/350/2363990466/222391/a6e9581d/5b7cba5bN0c18fb4f.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;拉拉裤&quot;,&quot;brand&quot;:&quot;巴布豆&quot;,&quot;spec&quot;:&quot;&#123;&#125;&quot;,&quot;sold&quot;:11,&quot;commentCount&quot;:33343434,&quot;isAD&quot;:false,&quot;status&quot;:2&#125;]<br>17:35:32:281 DEBUG 18620 --- [nio-8082-exec-1] com.hmall.api.client.ItemClient          : [ItemClient#queryItemByIds] &lt;--- END HTTP (369-byte body)<br></code></pre></td></tr></table></figure>
<p>第四章完成微服务拆分后，实际联调中暴露了<strong>多入口维护、用户信息传递、配置冗余</strong>等问题。所以后续将会通过<strong>微服务网关</strong>解决请求入口与鉴权问题，通过<strong>Nacos 统一配置</strong>解决配置管理问题。</p>
<h1>5. 网关路由</h1>
<h2 id="5-1-认识网关">5.1 认识网关</h2>
<h3 id="5-1-1-网关的定义与作用">5.1.1 网关的定义与作用</h3>
<p>网关是网络数据传输的 “关口”，负责在不同网络间进行<strong>路由转发、安全校验、数据过滤</strong>。通俗来讲，网关类似园区传达室的 “大爷”，承担两大核心职责：</p>
<ul>
<li><strong>安全拦截</strong>：验证访问者身份，拦截非法请求；</li>
<li><strong>路由转发</strong>：接收外部请求，传递给目标接收者。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb070c42bd.png" alt="image"></p>
<p>在微服务架构中，前端请求不直接访问微服务，必须经过网关层，流程如下：</p>
<ol>
<li>网关对请求进行<strong>登录身份校验</strong>，校验通过才允许放行；</li>
<li>校验通过后，网关根据请求特征判断目标微服务，将请求<strong>转发</strong>至对应服务。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb0765a39b.png" alt="image"></p>
<h3 id="5-1-2-SpringCloud-中的网关方案">5.1.2 SpringCloud 中的网关方案</h3>
<p>SpringCloud 提供两种网关实现，目前主流为 SpringCloudGateway：</p>
<table>
<thead>
<tr>
<th>网关方案</th>
<th>技术基础</th>
<th>性能特点</th>
<th>现状</th>
</tr>
</thead>
<tbody>
<tr>
<td>Netflix Zuul</td>
<td>Servlet 3.x</td>
<td>同步阻塞模型</td>
<td>已淘汰</td>
</tr>
<tr>
<td>SpringCloudGateway</td>
<td>Spring WebFlux</td>
<td>响应式编程，高吞吐</td>
<td>主流推荐</td>
</tr>
</tbody>
</table>
<p>SpringCloudGateway 官方网站：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-gateway#learn">https://spring.io/projects/spring-cloud-gateway#learn</a></p>
<h2 id="5-2-快速入门：实现网关路由">5.2 快速入门：实现网关路由</h2>
<p>网关本身是独立的微服务，需通过创建模块、配置依赖与路由规则实现功能。核心步骤为：<strong>创建项目→引入依赖→编写启动类→配置路由→测试验证</strong>。</p>
<h3 id="5-2-1-步骤-1：创建网关模块（hm-gateway）">5.2.1 步骤 1：创建网关模块（hm-gateway）</h3>
<p>在<code>hmall</code>父工程下新建 Maven 模块，命名为<code>hm-gateway</code>，作为网关微服务：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb0d6718ba.png" alt="image"></p>
<h3 id="5-2-2-步骤-2：引入核心依赖">5.2.2 步骤 2：引入核心依赖</h3>
<p>在<code>hm-gateway</code>的<code>pom.xml</code>中添加网关、Nacos 服务发现、负载均衡依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hmall<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hm-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 公共模块（工具类、通用DTO） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hm-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- SpringCloudGateway 核心依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Nacos服务发现（网关从Nacos获取微服务地址） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 负载均衡（网关转发时实现实例负载均衡） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h3 id="5-2-3-步骤-3：编写启动类">5.2.3 步骤 3：编写启动类</h3>
<p>在<code>com.hmall.gateway</code>包下创建启动类，无需额外注解（<code>@SpringBootApplication</code>包含自动配置）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb0f40345f.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.gateway;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<br><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GatewayApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="5-2-4-步骤-4：配置路由规则">5.2.4 步骤 4：配置路由规则</h3>
<p>在<code>hm-gateway</code>的<code>resources</code>目录创建<code>application.yaml</code>，配置端口、Nacos 地址及路由规则（需替换 Nacos 地址为实际虚拟机 IP）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <span class="hljs-comment"># 网关端口（前端统一访问入口）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span> <span class="hljs-comment"># 网关服务名（注册到Nacos）</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># Nacos服务地址</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 1. 商品服务路由</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span> <span class="hljs-comment"># 路由唯一ID（自定义，不可重复）</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span> <span class="hljs-comment"># 目标服务（lb=负载均衡，从Nacos拉取实例）</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># 路由断言（匹配请求路径）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**,/search/**</span> <span class="hljs-comment"># 匹配/items/、/search/下所有路径</span><br>        <span class="hljs-comment"># 2. 购物车服务路由</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">cart</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://cart-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/carts/**</span><br>        <span class="hljs-comment"># 3. 用户服务路由</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/users/**,/addresses/**</span><br>        <span class="hljs-comment"># 4. 交易服务路由</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">trade</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://trade-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/orders/**</span><br>        <span class="hljs-comment"># 5. 支付服务路由</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">pay</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://pay-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/pay-orders/**</span><br></code></pre></td></tr></table></figure>
<h3 id="5-2-5-步骤-5：测试路由功能">5.2.5 步骤 5：测试路由功能</h3>
<ol>
<li>
<p><strong>启动服务</strong>：依次启动 Nacos、<code>GatewayApplication</code>、<code>item-service</code>；</p>
</li>
<li>
<p><strong>访问测试</strong>：通过网关访问商品接口，URL 格式为<code>http://网关IP:网关端口/微服务接口路径</code></p>
<p>，例如：<a target="_blank" rel="noopener" href="http://localhost:8080/items/page?pageNo=1&amp;pageSize=1">http://localhost:8080/items/page?pageNo=1&amp;pageSize=1</a></p>
</li>
<li>
<p><strong>验证结果</strong>：接口返回商品数据，说明路由转发成功。</p>
</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb15bd3997.png" alt="image"></p>
<p>启动<code>user-service</code>、<code>cart-service</code>后，前端可通过<code>http://localhost:8080</code>统一入口访问所有微服务功能，无需维护多个服务地址。</p>
<h2 id="5-3-路由规则与断言详解">5.3 路由规则与断言详解</h2>
<h3 id="5-3-1-路由规则核心结构">5.3.1 路由规则核心结构</h3>
<p>路由规则的基本语法如下，<code>routes</code>是<code>RouteDefinition</code>的集合，支持多规则配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**,/search/**</span><br></code></pre></td></tr></table></figure>
<p><code>routes</code>对应的类型及<code>RouteDefinition</code>核心属性：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb1cc13330.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb1cc6a7e1.png" alt="image"></p>
<p><code>RouteDefinition</code>核心属性说明：</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>id</code></td>
<td>路由唯一标识（自定义，不可重复）</td>
</tr>
<tr>
<td><code>predicates</code></td>
<td>路由断言：判断请求是否符合当前规则</td>
</tr>
<tr>
<td><code>filters</code></td>
<td>路由过滤：请求 / 响应的加工逻辑（后续讲解）</td>
</tr>
<tr>
<td><code>uri</code></td>
<td>目标服务地址：<code>lb://服务名</code>代表负载均衡，从 Nacos 获取实例列表</td>
</tr>
</tbody>
</table>
<h3 id="5-3-2-常用路由断言类型">5.3.2 常用路由断言类型</h3>
<p>路由断言是网关匹配请求的 “规则”，SpringCloudGateway 支持多种断言类型，覆盖路径、参数、时间等场景：</p>
<table>
<thead>
<tr>
<th>断言名称</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>After</td>
<td>匹配某个时间点<strong>之后</strong>的请求</td>
<td><code>- After=2037-01-20T17:42:47.789-07:00[America/Denver]</code></td>
</tr>
<tr>
<td>Before</td>
<td>匹配某个时间点<strong>之前</strong>的请求</td>
<td><code>- Before=2031-04-13T15:14:47.433+08:00[Asia/Shanghai]</code></td>
</tr>
<tr>
<td>Between</td>
<td>匹配两个时间点<strong>之间</strong>的请求</td>
<td><code>- Between=2037-01-20T17:42:47.789-07:00[America/Denver], 2037-01-21T17:42:47.789-07:00[America/Denver]</code></td>
</tr>
<tr>
<td>Cookie</td>
<td>匹配包含<strong>指定 Cookie</strong>的请求</td>
<td><code>- Cookie=chocolate, ch.p</code>（Cookie 键为 chocolate，值匹配 ch.p 正则）</td>
</tr>
<tr>
<td>Header</td>
<td>匹配包含<strong>指定请求头</strong>的请求</td>
<td><code>- Header=X-Request-Id, \d+</code>（请求头键为 X-Request-Id，值为数字）</td>
</tr>
<tr>
<td>Host</td>
<td>匹配访问<strong>指定域名</strong>的请求</td>
<td><code>- Host=**.somehost.org,**.anotherhost.org</code>（匹配二级域名）</td>
</tr>
<tr>
<td>Method</td>
<td>匹配<strong>指定 HTTP 方法</strong>的请求</td>
<td><code>- Method=GET,POST</code>（仅允许 GET、POST 请求）</td>
</tr>
<tr>
<td><strong>Path</strong></td>
<td>匹配<strong>指定路径</strong>的请求（最常用）</td>
<td><code>- Path=/red/&#123;segment&#125;,/blue/**</code>（/red/xxx 或 /blue/ 下所有路径）</td>
</tr>
<tr>
<td>Query</td>
<td>匹配包含<strong>指定参数</strong>的请求</td>
<td><code>- Query=name</code>（必须包含 name 参数）；<code>- Query=name, Jack</code>（name 参数值为 Jack）</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>匹配<strong>指定 IP 来源</strong>的请求</td>
<td><code>- RemoteAddr=192.168.1.1/24</code>（IP 在 192.168.1.0-255 范围）</td>
</tr>
<tr>
<td>Weight</td>
<td>基于<strong>权重</strong>的路由（负载均衡扩展）</td>
<td><code>- Weight=group1, 80</code>（group1 分组中占 80% 权重）</td>
</tr>
</tbody>
</table>
<h3 id="5-3-3-断言组合使用">5.3.3 断言组合使用</h3>
<p>多个断言之间为 **“与” 关系 **，需同时满足才会触发路由。例如：仅允许 GET 请求访问<code>/items</code>路径：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span> <span class="hljs-comment"># 同时满足路径和方法断言</span><br></code></pre></td></tr></table></figure>
<h1>6. 网关登录校验</h1>
<h2 id="6-1-鉴权思路分析">6.1 鉴权思路分析</h2>
<p>单体架构中，一次登录校验即可在所有业务中共享用户信息；但微服务拆分后，服务独立部署、数据不共享，若每个微服务单独实现登录校验，会存在<strong>秘钥泄露风险</strong>和<strong>代码冗余问题</strong>。</p>
<h3 id="6-1-1-核心痛点">6.1.1 核心痛点</h3>
<ul>
<li><strong>安全性差</strong>：每个微服务需存储 JWT 秘钥，易泄露；</li>
<li><strong>开发效率低</strong>：重复编写登录校验、权限判断代码。</li>
</ul>
<h3 id="6-1-2-网关统一鉴权方案">6.1.2 网关统一鉴权方案</h3>
<p>网关作为所有请求的入口，可集中处理登录校验，解决上述问题：</p>
<ul>
<li><strong>秘钥集中管理</strong>：仅网关和用户服务保存 JWT 秘钥；</li>
<li><strong>代码统一开发</strong>：登录校验逻辑仅在网关实现一次。</li>
</ul>
<p><strong>鉴权流程</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb3e45d129.png" alt="image"></p>
<h3 id="6-1-3-待解决问题">6.1.3 待解决问题</h3>
<ul>
<li>如何在网关转发请求前执行登录校验？</li>
<li>网关校验通过后，如何将用户信息传递给微服务？</li>
<li>微服务间调用（不经过网关）如何传递用户信息？</li>
</ul>
<h2 id="6-2-网关过滤器：鉴权的技术基础">6.2 网关过滤器：鉴权的技术基础</h2>
<p>网关的请求处理依赖<strong>过滤器链</strong>，登录校验需通过过滤器在请求转发前执行。</p>
<h3 id="6-2-1-Gateway-工作原理">6.2.1 Gateway 工作原理</h3>
<p>Gateway 处理请求的核心流程：</p>
<ol>
<li>客户端请求进入网关，<code>HandlerMapping</code>匹配对应的路由规则（<code>Route</code>）；</li>
<li><code>WebHandler</code>加载该路由的<strong>过滤器链（Filter Chain）</strong>，按顺序执行过滤器；</li>
<li>过滤器逻辑分为<code>pre</code>（转发前）和<code>post</code>（响应后）两部分，仅<code>pre</code>逻辑全部通过后，请求才会转发到微服务；</li>
<li>微服务返回响应后，倒序执行过滤器的<code>post</code>逻辑，最终返回给客户端。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb4240f38c.png" alt="image"></p>
<p>关键结论：登录校验逻辑需实现为<code>pre</code>阶段的过滤器，且执行顺序需在请求转发过滤器（<code>NettyRoutingFilter</code>）之前。</p>
<h3 id="6-2-2-网关过滤器类型">6.2.2 网关过滤器类型</h3>
<p>Gateway 提供两种核心过滤器，均支持自定义：</p>
<table>
<thead>
<tr>
<th>过滤器类型</th>
<th>作用范围</th>
<th>配置方式</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GatewayFilter</code></td>
<td>指定路由（灵活）</td>
<td>需在 yaml 中配置</td>
</tr>
<tr>
<td><code>GlobalFilter</code></td>
<td>所有路由（全局）</td>
<td>无需配置，自动生效</td>
</tr>
</tbody>
</table>
<p>两种过滤器的方法签名一致，最终会被统一封装到过滤器链中，按<code>Order</code>排序执行（值越小，优先级越高）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> exchange 请求上下文（含request、response）</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> chain 过滤器链（用于传递请求）</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 标记请求是否放行：chain.filter(exchange) 为放行</span><br><span class="hljs-comment"> */</span><br>Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;<br></code></pre></td></tr></table></figure>
<h3 id="6-2-3-内置-GatewayFilter-使用">6.2.3 内置 GatewayFilter 使用</h3>
<p>Gateway 内置多种<code>GatewayFilter</code>（如添加请求头、路径重写），无需编码，直接在 yaml 中配置即可。</p>
<h4 id="示例：添加请求头过滤器">示例：添加请求头过滤器</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-comment"># 作用于所有路由的默认过滤器</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Gateway,</span> <span class="hljs-string">hmall-gateway</span> <span class="hljs-comment"># 给所有请求添加头信息</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**</span><br>          <span class="hljs-comment"># 仅作用于当前路由的过滤器</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=X-Service,</span> <span class="hljs-string">item-service</span><br></code></pre></td></tr></table></figure>
<h2 id="6-3-自定义过滤器">6.3 自定义过滤器</h2>
<p>实际业务中，内置过滤器无法满足复杂需求（如登录校验），需自定义过滤器。</p>
<h3 id="6-3-1-自定义-GatewayFilter">6.3.1 自定义 GatewayFilter</h3>
<p>需继承<code>AbstractGatewayFilterFactory</code>，支持动态配置参数，作用于指定路由。</p>
<h4 id="示例-1：基础无参过滤器">示例 1：基础无参过滤器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-comment">// 类名必须以GatewayFilterFactory为后缀</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrintAnyGatewayFilterFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractGatewayFilterFactory</span>&lt;Object&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GatewayFilter <span class="hljs-title function_">apply</span><span class="hljs-params">(Object config)</span> &#123;<br>        <span class="hljs-keyword">return</span> (exchange, chain) -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;GatewayFilter执行了&quot;</span>);<br>            <span class="hljs-keyword">return</span> chain.filter(exchange); <span class="hljs-comment">// 放行</span><br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>配置使用</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">PrintAny</span> <span class="hljs-comment"># 直接使用类名前缀</span><br></code></pre></td></tr></table></figure>
<h4 id="示例-2：带参数的过滤器">示例 2：带参数的过滤器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrintParamGatewayFilterFactory</span> <br>       <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractGatewayFilterFactory</span>&lt;PrintParamGatewayFilterFactory.Config&gt; &#123;<br><br>    <span class="hljs-comment">// 过滤器逻辑（支持排序）</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GatewayFilter <span class="hljs-title function_">apply</span><span class="hljs-params">(Config config)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderedGatewayFilter</span>((exchange, chain) -&gt; &#123;<br>            <span class="hljs-comment">// 获取配置参数</span><br>            System.out.println(<span class="hljs-string">&quot;a=&quot;</span> + config.getA() + <span class="hljs-string">&quot;, b=&quot;</span> + config.getB());<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;, <span class="hljs-number">100</span>); <span class="hljs-comment">// 执行顺序：100</span><br>    &#125;<br><br>    <span class="hljs-comment">// 自定义配置类（存储参数）</span><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> &#123;<br>        <span class="hljs-keyword">private</span> String a;<br>        <span class="hljs-keyword">private</span> String b;<br>    &#125;<br><br>    <span class="hljs-comment">// 指定参数顺序（用于yaml简洁配置）</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">shortcutFieldOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> List.of(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 指定配置类类型</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;Config&gt; <span class="hljs-title function_">getConfigClass</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Config.class;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>配置使用</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 方式1：按顺序传参（简洁）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">PrintParam=123,</span> <span class="hljs-number">456</span><br><br><span class="hljs-comment"># 方式2：指定参数名（灵活）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PrintParam</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-attr">a:</span> <span class="hljs-number">123</span><br>            <span class="hljs-attr">b:</span> <span class="hljs-number">456</span><br></code></pre></td></tr></table></figure>
<h3 id="6-3-2-自定义-GlobalFilter">6.3.2 自定义 GlobalFilter</h3>
<p>直接实现<code>GlobalFilter</code>和<code>Ordered</code>接口，作用于所有路由，无需配置，适合全局逻辑（如登录校验）。</p>
<h4 id="示例：简单拦截过滤器">示例：简单拦截过滤器</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">// 拦截未登录请求</span><br>        System.out.println(<span class="hljs-string">&quot;未登录，拦截请求&quot;</span>);<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        response.setRawStatusCode(<span class="hljs-number">401</span>); <span class="hljs-comment">// 401未授权</span><br>        <span class="hljs-keyword">return</span> response.setComplete(); <span class="hljs-comment">// 终止请求</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 执行顺序：0（优先级高）</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="6-4-实战：网关登录校验（基于-JWT）">6.4 实战：网关登录校验（基于 JWT）</h2>
<p>利用<code>GlobalFilter</code>实现 JWT 校验，核心流程：<strong>排除白名单→获取 token→校验 token→传递用户信息→放行</strong>。</p>
<h3 id="6-4-1-准备-JWT-工具">6.4.1 准备 JWT 工具</h3>
<p>从<code>hm-service</code>拷贝 JWT 相关工具到网关模块：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb5b1dff52.png" alt="image"></p>
<ul>
<li><code>JwtTool</code>：JWT 生成、解析工具；</li>
<li><code>JwtProperties</code>：JWT 配置（秘钥、过期时间）；</li>
<li><code>AuthProperties</code>：白名单配置（无需校验的路径）；</li>
<li>秘钥文件<code>hmall.jks</code>。</li>
</ul>
<p><strong>配置 yaml 参数</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hm:</span><br>  <span class="hljs-attr">jwt:</span><br>    <span class="hljs-attr">location:</span> <span class="hljs-string">classpath:hmall.jks</span> <span class="hljs-comment"># 秘钥文件路径</span><br>    <span class="hljs-attr">alias:</span> <span class="hljs-string">hmall</span> <span class="hljs-comment"># 秘钥别名</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">hmall123</span> <span class="hljs-comment"># 秘钥密码</span><br>    <span class="hljs-attr">tokenTTL:</span> <span class="hljs-string">30m</span> <span class="hljs-comment"># token有效期</span><br>  <span class="hljs-attr">auth:</span><br>    <span class="hljs-attr">excludePaths:</span> <span class="hljs-comment"># 白名单路径（无需登录）</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/search/**</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/users/login</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/items/**</span><br></code></pre></td></tr></table></figure>
<h3 id="6-4-2-实现登录校验过滤器">6.4.2 实现登录校验过滤器</h3>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb5f67cb71.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.gateway.filter;<br><br><span class="hljs-keyword">import</span> com.hmall.common.exception.UnauthorizedException;<br><span class="hljs-keyword">import</span> com.hmall.common.utils.CollUtils;<br><span class="hljs-keyword">import</span> com.hmall.gateway.config.AuthProperties;<br><span class="hljs-keyword">import</span> com.hmall.gateway.util.JwtTool;<br><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;<br><span class="hljs-keyword">import</span> org.springframework.core.Ordered;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpRequest;<br><span class="hljs-keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.AntPathMatcher;<br><span class="hljs-keyword">import</span> org.springframework.web.server.ServerWebExchange;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-meta">@EnableConfigurationProperties(AuthProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JwtTool jwtTool;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AuthProperties authProperties;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AntPathMatcher</span> <span class="hljs-variable">antPathMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>(); <span class="hljs-comment">// 路径匹配工具</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">// 1. 排除白名单路径</span><br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> request.getPath().toString();<br>        <span class="hljs-keyword">if</span> (isExclude(path)) &#123;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange); <span class="hljs-comment">// 放行</span><br>        &#125;<br><br>        <span class="hljs-comment">// 2. 获取请求头中的token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (!CollUtils.isEmpty(request.getHeaders().get(<span class="hljs-string">&quot;authorization&quot;</span>))) &#123;<br>            token = request.getHeaders().get(<span class="hljs-string">&quot;authorization&quot;</span>).get(<span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 3. 校验token</span><br>        Long userId;<br>        <span class="hljs-keyword">try</span> &#123;<br>            userId = jwtTool.parseToken(token); <span class="hljs-comment">// 解析token获取用户ID</span><br>        &#125; <span class="hljs-keyword">catch</span> (UnauthorizedException e) &#123;<br>            <span class="hljs-comment">// 校验失败，返回401</span><br>            <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>            response.setRawStatusCode(<span class="hljs-number">401</span>);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">// 4. 传递用户信息（后续补充）</span><br>        System.out.println(<span class="hljs-string">&quot;登录用户ID：&quot;</span> + userId);<br><br>        <span class="hljs-comment">// 5. 放行</span><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-comment">// 判断路径是否在白名单中</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExclude</span><span class="hljs-params">(String path)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String pattern : authProperties.getExcludePaths()) &#123;<br>            <span class="hljs-keyword">if</span> (antPathMatcher.match(pattern, path)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 优先执行</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="6-4-3-测试鉴权效果">6.4.3 测试鉴权效果</h3>
<ol>
<li>
<p><strong>启动服务</strong>：网关、用户服务、商品服务；</p>
</li>
<li>
<p>测试白名单路径：访问 <a target="_blank" rel="noopener" href="http://localhost:8080/items/1">http://localhost:8080/items/1</a> ，未登录可正常返回数据；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb62607d6f.png" alt="image"></p>
</li>
<li>
<p>测试受保护路径：访问 <a target="_blank" rel="noopener" href="http://localhost:8080/carts">http://localhost:8080/carts</a> ，未登录返回 401；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb635ad2d3.png" alt="image"></p>
</li>
</ol>
<h2 id="6-5-微服务获取用户信息">6.5 微服务获取用户信息</h2>
<p>网关校验通过后，需将用户信息传递给微服务。通过<strong>请求头 + 拦截器 + ThreadLocal</strong>实现：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb66e86c9b.png" alt="image"></p>
<ul>
<li>网关：将用户 ID 存入请求头；</li>
<li>微服务：通过拦截器读取请求头，存入 ThreadLocal 供业务使用。</li>
</ul>
<h3 id="6-5-1-网关传递用户信息">6.5.1 网关传递用户信息</h3>
<p>修改登录校验拦截器的处理逻辑，保存用户信息到请求头中：</p>
<h3 id="image6-5-2-微服务拦截器获取用户"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb6a31923d.png" alt="image">6.5.2 微服务拦截器获取用户</h3>
<p>在<code>hm-common</code>模块实现拦截器，统一处理用户信息（所有微服务复用）。</p>
<h4 id="步骤-1：ThreadLocal-工具类">步骤 1：ThreadLocal 工具类</h4>
<p><code>hm-common</code>中已提供<code>UserContext</code>，用于存储当前线程的用户信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb6c7f0bff.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb6e3404c5.png" alt="image"></p>
<h4 id="步骤-2：实现拦截器">步骤 2：实现拦截器</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb76e623a2.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.common.interceptor;<br><br><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;<br><span class="hljs-keyword">import</span> com.hmall.common.utils.UserContext;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;<br>        <span class="hljs-comment">// 读取请求头中的用户ID</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;user-info&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(userId)) &#123;<br>            UserContext.setUser(Long.valueOf(userId)); <span class="hljs-comment">// 存入ThreadLocal</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 放行</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> &#123;<br>        UserContext.removeUser(); <span class="hljs-comment">// 清除ThreadLocal</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="步骤-3：自动装配拦截器">步骤 3：自动装配拦截器</h4>
<p>在<code>hm-common</code>中配置拦截器，并通过 SpringBoot 自动装配生效：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb7831ac24.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.common.config;<br><br><span class="hljs-keyword">import</span> com.hmall.common.interceptor.UserInfoInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.DispatcherServlet;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnClass(DispatcherServlet.class)</span> <span class="hljs-comment">// 仅当存在SpringMVC时生效</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfoInterceptor</span>()); <span class="hljs-comment">// 注册拦截器</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="步骤-4：配置自动装配">步骤 4：配置自动装配</h4>
<p>在<code>hm-common</code>的<code>resources/META-INF/spring.factories</code>中添加配置，确保微服务能扫描到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb7a25968d.png" alt="image"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="hljs-string">\</span><br><span class="hljs-string">  com.hmall.common.config.MvcConfig</span><br></code></pre></td></tr></table></figure>
<h3 id="6-5-3-恢复业务代码">6.5.3 恢复业务代码</h3>
<p>以购物车服务为例，恢复<code>CartServiceImpl</code>中读取当前用户的逻辑：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb7cd8ae75.png" alt="image"></p>
<h2 id="6-6-OpenFeign-传递用户信息">6.6 OpenFeign 传递用户信息</h2>
<p>微服务间通过 OpenFeign 调用时，不经过网关，需手动传递用户信息。利用 Feign 的<code>RequestInterceptor</code>实现自动携带请求头。</p>
<h3 id="6-6-1-实现-Feign-拦截器">6.6.1 实现 Feign 拦截器</h3>
<p>在<code>hm-api</code>模块的<code>DefaultFeignConfig</code>中添加拦截器，自动将用户 ID 存入请求头：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.api.config;<br><br><span class="hljs-keyword">import</span> com.hmall.common.utils.UserContext;<br><span class="hljs-keyword">import</span> feign.RequestInterceptor;<br><span class="hljs-keyword">import</span> feign.RequestTemplate;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFeignConfig</span> &#123;<br>    <span class="hljs-comment">// 其他配置（如日志级别）...</span><br><br>    <span class="hljs-comment">// Feign请求拦截器：自动传递用户信息</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RequestInterceptor <span class="hljs-title function_">userInfoRequestInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestInterceptor</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate template)</span> &#123;<br>                <span class="hljs-comment">// 从ThreadLocal获取用户ID</span><br>                <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserContext.getUser();<br>                <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// 添加请求头</span><br>                    template.header(<span class="hljs-string">&quot;user-info&quot;</span>, userId.toString());<br>                &#125;<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="6-6-2-测试微服务间调用">6.6.2 测试微服务间调用</h3>
<p>以 “下单业务” 为例：</p>
<ol>
<li>前端请求订单服务（<code>trade-service</code>）创建订单；</li>
<li>订单服务通过 OpenFeign 调用购物车服务（<code>cart-service</code>）清理购物车；</li>
<li>购物车服务通过拦截器读取<code>user-info</code>请求头，获取当前用户 ID，完成清理。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfb84be04ee.png" alt="image"></p>
<p>此时，微服务间调用可正常获取用户信息，无需额外传递参数。</p>
<h1>7. 配置管理</h1>
<h2 id="7-1-配置管理概述">7.1 配置管理概述</h2>
<h3 id="7-1-1-微服务配置的核心痛点">7.1.1 微服务配置的核心痛点</h3>
<p>前文解决了远程调用、服务注册发现、网关路由等问题，但仍存在三大配置相关痛点：</p>
<ul>
<li><strong>配置重复</strong>：每个微服务都包含数据库、日志、Swagger 等重复配置，维护成本高；</li>
<li><strong>修改繁琐</strong>：配置写死在本地文件，修改后需重启服务才能生效；</li>
<li><strong>路由静态</strong>：网关路由配置固化，变更需重启网关。</li>
</ul>
<h3 id="7-1-2-Nacos-配置中心解决方案">7.1.2 Nacos 配置中心解决方案</h3>
<p>Nacos 兼具<strong>服务注册发现</strong>和<strong>配置管理</strong>双重能力，可实现配置的集中存储、动态更新，且无需重启服务。其核心价值：</p>
<ul>
<li>集中管理共享配置，消除重复；</li>
<li>配置变更实时推送，实现热更新；</li>
<li>支持网关动态路由，无需重启网关。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfba2618f96.png" alt="image"></p>
<h2 id="7-2-配置共享：消除重复配置">7.2 配置共享：消除重复配置</h2>
<p>配置共享是将多个微服务的通用配置（如数据库、日志）抽取到 Nacos 集中管理，微服务按需拉取合并。以<code>cart-service</code>为例，分两步实现：</p>
<h3 id="7-2-1-步骤-1：在-Nacos-添加共享配置">7.2.1 步骤 1：在 Nacos 添加共享配置</h3>
<p>识别<code>cart-service</code>中的重复配置，在 Nacos 控制台创建对应共享配置文件（<code>配置管理→配置列表→+</code>）。</p>
<h4 id="1-共享数据库配置（dataId：shared-jdbc-yaml）">1. 共享数据库配置（dataId：shared-jdbc.yaml）</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbacca8d34.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbaccb5379.png" alt="image"></p>
<p><strong>配置内容</strong>（支持动态参数，默认值 + 覆盖机制）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://$&#123;hm.db.host:192.168.150.101&#125;:$&#123;hm.db.port:3306&#125;/$&#123;hm.db.database&#125;?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">$&#123;hm.db.un:root&#125;</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">$&#123;hm.db.pw:123&#125;</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">default-enum-type-handler:</span> <span class="hljs-string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">update-strategy:</span> <span class="hljs-string">not_null</span><br>      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span><br></code></pre></td></tr></table></figure>
<h4 id="2-共享日志配置（dataId：shared-log-yaml）">2. 共享日志配置（dataId：shared-log.yaml）</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">com.hmall:</span> <span class="hljs-string">debug</span><br>  <span class="hljs-attr">pattern:</span><br>    <span class="hljs-attr">dateformat:</span> <span class="hljs-string">HH:mm:ss:SSS</span><br>  <span class="hljs-attr">file:</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">&quot;logs/$&#123;spring.application.name&#125;&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="3-共享-Swagger-配置（dataId：shared-swagger-yaml）">3. 共享 Swagger 配置（dataId：shared-swagger.yaml）</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">knife4j:</span><br>  <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">openapi:</span><br>    <span class="hljs-attr">title:</span> <span class="hljs-string">$&#123;hm.swagger.title:黑马商城接口文档&#125;</span><br>    <span class="hljs-attr">description:</span> <span class="hljs-string">$&#123;hm.swagger.description:黑马商城接口文档&#125;</span><br>    <span class="hljs-attr">email:</span> <span class="hljs-string">$&#123;hm.swagger.email:zhanghuyi@itcast.cn&#125;</span><br>    <span class="hljs-attr">concat:</span> <span class="hljs-string">$&#123;hm.swagger.concat:虎哥&#125;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">https://www.itcast.cn</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.0.0</span><br>    <span class="hljs-attr">group:</span><br>      <span class="hljs-attr">default:</span><br>        <span class="hljs-attr">group-name:</span> <span class="hljs-string">default</span><br>        <span class="hljs-attr">api-rule:</span> <span class="hljs-string">package</span><br>        <span class="hljs-attr">api-rule-resources:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">$&#123;hm.swagger.package&#125;</span><br></code></pre></td></tr></table></figure>
<h3 id="7-2-2-步骤-2：微服务拉取共享配置">7.2.2 步骤 2：微服务拉取共享配置</h3>
<p>微服务需通过<code>bootstrap.yaml</code>（引导阶段加载）指定 Nacos 地址及共享配置，再合并本地<code>application.yaml</code>。</p>
<h4 id="1-引入依赖">1. 引入依赖</h4>
<p>在<code>cart-service</code>的<code>pom.xml</code>中添加 Nacos 配置及 bootstrap 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Nacos配置管理 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 加载bootstrap文件（优先级高于application.yaml） --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="2-创建-bootstrap-yaml">2. 创建 bootstrap.yaml</h4>
<p><code>bootstrap.yaml</code>在 SpringCloud 引导阶段加载，用于配置 Nacos 地址及共享配置（解决 “先有鸡还是先有蛋” 的 Nacos 地址获取问题）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cart-service</span> <span class="hljs-comment"># 服务名</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment"># 激活的环境</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span> <span class="hljs-comment"># Nacos地址（Ubuntu虚拟机IP）</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment"># 配置文件格式</span><br>        <span class="hljs-attr">shared-configs:</span> <span class="hljs-comment"># 拉取的共享配置列表</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">dataId:</span> <span class="hljs-string">shared-jdbc.yaml</span> <span class="hljs-comment"># 数据库+MyBatis配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">dataId:</span> <span class="hljs-string">shared-log.yaml</span> <span class="hljs-comment"># 日志配置</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">dataId:</span> <span class="hljs-string">shared-swagger.yaml</span> <span class="hljs-comment"># Swagger配置</span><br></code></pre></td></tr></table></figure>
<h4 id="3-简化本地-application-yaml">3. 简化本地 application.yaml</h4>
<p>删除重复配置，仅保留服务特有配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span> <span class="hljs-comment"># 服务端口</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">okhttp:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启Feign的OKHttp连接池</span><br><span class="hljs-attr">hm:</span><br>  <span class="hljs-attr">swagger:</span><br>    <span class="hljs-attr">title:</span> <span class="hljs-string">购物车服务接口文档</span> <span class="hljs-comment"># 覆盖共享配置的title</span><br>    <span class="hljs-attr">package:</span> <span class="hljs-string">com.hmall.cart.controller</span> <span class="hljs-comment"># 接口扫描包</span><br>  <span class="hljs-attr">db:</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-string">hm-cart</span> <span class="hljs-comment"># 数据库名（对应shared-jdbc中的$&#123;hm.db.database&#125;）</span><br></code></pre></td></tr></table></figure>
<h4 id="4-验证效果">4. 验证效果</h4>
<p>重启<code>cart-service</code>，验证数据库连接、日志输出、Swagger 文档均正常生效，说明共享配置拉取成功。</p>
<h3 id="7-2-3-关键原理：配置加载顺序">7.2.3 关键原理：配置加载顺序</h3>
<p>SpringCloud 配置加载优先级（从高到低）：</p>
<ol>
<li>Nacos 共享配置（<code>shared-configs</code>）；</li>
<li>Nacos 服务特有配置（<code>[服务名]-[环境].yaml</code>）；</li>
<li>本地<code>application-[环境].yaml</code>；</li>
<li>本地<code>application.yaml</code>。</li>
</ol>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbb797a214.png" alt="image"></p>
<h2 id="7-3-配置热更新：无需重启生效">7.3 配置热更新：无需重启生效</h2>
<p>配置热更新指 Nacos 配置修改后，微服务实时感知并应用新配置，无需重启。以 “购物车上限” 为例实现。</p>
<h3 id="7-3-1-步骤-1：在-Nacos-添加热更新配置">7.3.1 步骤 1：在 Nacos 添加热更新配置</h3>
<p>创建服务特有配置（dataId：<code>cart-service.yaml</code>，所有环境共享）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbbfb8a9a5.png" alt="image"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hm:</span><br>  <span class="hljs-attr">cart:</span><br>    <span class="hljs-attr">maxAmount:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 购物车商品数量上限（初始值1）</span><br></code></pre></td></tr></table></figure>
<h3 id="7-3-2-步骤-2：微服务读取热更新配置">7.3.2 步骤 2：微服务读取热更新配置</h3>
<p>通过<code>@ConfigurationProperties</code>注解绑定配置，自动支持热更新（无需<code>@RefreshScope</code>）。</p>
<h4 id="1-创建配置绑定类">1. 创建配置绑定类</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbc2256eab.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.cart.config;<br><br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;hm.cart&quot;)</span> <span class="hljs-comment">// 绑定配置前缀</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CartProperties</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer maxAmount; <span class="hljs-comment">// 对应nacos中的hm.cart.maxAmount</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="2-业务中使用配置">2. 业务中使用配置</h4>
<p>修改<code>CartServiceImpl</code>，替换硬编码的购物车上限：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbc3e3c94f.png" alt="image"></p>
<h3 id="7-3-3-步骤-3：测试热更新效果">7.3.3 步骤 3：测试热更新效果</h3>
<ol>
<li>
<p>初始测试：添加 2 个商品到购物车，触发 “超过上限 1” 的异常；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbca1b97ae.png" alt="image"></p>
</li>
<li>
<p>修改 Nacos 配置：将<code>maxAmount</code>改为 5；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbca20b6c7.png" alt="image"></p>
</li>
<li>
<p>无需重启测试：再次添加商品，可成功添加（上限变为 5），热更新生效。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbca2d8b25.png" alt="image"></p>
</li>
</ol>
<h2 id="7-4-动态路由：网关路由热更新">7.4 动态路由：网关路由热更新</h2>
<p>网关默认将路由配置缓存到内存，无法通过普通热更新修改。需手动监听 Nacos 配置变更，更新网关路由表。</p>
<h3 id="7-4-1-核心难点与解决方案">7.4.1 核心难点与解决方案</h3>
<table>
<thead>
<tr>
<th>难点</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>监听 Nacos 配置变更</td>
<td>利用<code>NacosConfigManager</code>获取<code>ConfigService</code>，添加监听器</td>
</tr>
<tr>
<td>更新网关路由表</td>
<td>利用<code>RouteDefinitionWriter</code>接口保存 / 删除路由</td>
</tr>
</tbody>
</table>
<h3 id="7-4-2-步骤-1：网关整合-Nacos-配置">7.4.2 步骤 1：网关整合 Nacos 配置</h3>
<h4 id="1-引入依赖-2">1. 引入依赖</h4>
<p>在<code>hm-gateway</code>的<code>pom.xml</code>中添加依赖（同微服务配置共享）：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Nacos配置管理 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 加载bootstrap文件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>
<h4 id="2-配置-bootstrap-yaml">2. 配置 bootstrap.yaml</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span> <span class="hljs-comment"># 网关服务名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span> <span class="hljs-comment"># Nacos地址</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br>        <span class="hljs-attr">shared-configs:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">dataId:</span> <span class="hljs-string">shared-log.yaml</span> <span class="hljs-comment"># 共享日志配置</span><br></code></pre></td></tr></table></figure>
<h4 id="3-简化-application-yaml">3. 简化 application.yaml</h4>
<p>删除本地路由配置，仅保留鉴权相关配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span> <span class="hljs-comment"># 网关端口</span><br><span class="hljs-attr">hm:</span><br>  <span class="hljs-attr">jwt:</span><br>    <span class="hljs-attr">location:</span> <span class="hljs-string">classpath:hmall.jks</span> <span class="hljs-comment"># 秘钥地址</span><br>    <span class="hljs-attr">alias:</span> <span class="hljs-string">hmall</span> <span class="hljs-comment"># 秘钥别名</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">hmall123</span> <span class="hljs-comment"># 秘钥密码</span><br>    <span class="hljs-attr">tokenTTL:</span> <span class="hljs-string">30m</span> <span class="hljs-comment"># 登录有效期</span><br>  <span class="hljs-attr">auth:</span><br>    <span class="hljs-attr">excludePaths:</span> <span class="hljs-comment"># 无需登录校验的路径</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/search/**</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/users/login</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/items/**</span><br></code></pre></td></tr></table></figure>
<h3 id="7-4-3-步骤-2：实现动态路由加载器">7.4.3 步骤 2：实现动态路由加载器</h3>
<p>编写<code>DynamicRouteLoader</code>类，监听 Nacos 路由配置并更新网关路由表。</p>
<h4 id="1-动态路由加载器代码">1. 动态路由加载器代码</h4>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbd2fec33d.png" alt="image"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.hmall.gateway.route;<br><br><span class="hljs-keyword">import</span> cn.hutool.json.JSONUtil;<br><span class="hljs-keyword">import</span> com.alibaba.cloud.nacos.NacosConfigManager;<br><span class="hljs-keyword">import</span> com.alibaba.nacos.api.config.listener.Listener;<br><span class="hljs-keyword">import</span> com.alibaba.nacos.api.exception.NacosException;<br><span class="hljs-keyword">import</span> com.hmall.common.utils.CollUtils;<br><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.route.RouteDefinition;<br><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.route.RouteDefinitionWriter;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Set;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executor;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRouteLoader</span> &#123;<br><br>    <span class="hljs-comment">// 路由更新工具（SpringCloud Gateway提供）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RouteDefinitionWriter writer;<br>    <span class="hljs-comment">// Nacos配置管理（自动装配，用于获取ConfigService）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NacosConfigManager nacosConfigManager;<br><br>    <span class="hljs-comment">// Nacos中路由配置的dataId和group</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;gateway-routes.json&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;DEFAULT_GROUP&quot;</span>;<br>    <span class="hljs-comment">// 记录已加载的路由ID，用于更新前删除旧路由</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; routeIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 项目启动时执行初始化</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initRouteConfigListener</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NacosException &#123;<br>        <span class="hljs-comment">// 1. 注册监听器并首次拉取配置（getConfigAndSignListener=拉取+监听）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">configInfo</span> <span class="hljs-operator">=</span> nacosConfigManager.getConfigService()<br>                .getConfigAndSignListener(dataId, group, <span class="hljs-number">5000</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getExecutor</span><span class="hljs-params">()</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 使用默认线程池</span><br>                    &#125;<br><br>                    <span class="hljs-comment">// 配置变更时触发</span><br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveConfigInfo</span><span class="hljs-params">(String configInfo)</span> &#123;<br>                        updateConfigInfo(configInfo);<br>                    &#125;<br>                &#125;);<br>        <span class="hljs-comment">// 2. 首次启动加载路由</span><br>        updateConfigInfo(configInfo);<br>    &#125;<br><br>    <span class="hljs-comment">// 解析配置并更新路由表</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateConfigInfo</span><span class="hljs-params">(String configInfo)</span> &#123;<br>        log.debug(<span class="hljs-string">&quot;监听到路由配置变更：&#123;&#125;&quot;</span>, configInfo);<br>        <span class="hljs-comment">// 1. JSON反序列化为RouteDefinition列表</span><br>        List&lt;RouteDefinition&gt; routeDefinitions = JSONUtil.toList(configInfo, RouteDefinition.class);<br>        <span class="hljs-comment">// 2. 清空旧路由</span><br>        routeIds.forEach(routeId -&gt; writer.delete(Mono.just(routeId)).subscribe());<br>        routeIds.clear();<br>        <span class="hljs-comment">// 3. 加载新路由</span><br>        <span class="hljs-keyword">if</span> (CollUtils.isNotEmpty(routeDefinitions)) &#123;<br>            routeDefinitions.forEach(route -&gt; &#123;<br>                writer.save(Mono.just(route)).subscribe(); <span class="hljs-comment">// 保存新路由</span><br>                routeIds.add(route.getId()); <span class="hljs-comment">// 记录路由ID</span><br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="7-4-4-步骤-3：在-Nacos-添加路由配置">7.4.4 步骤 3：在 Nacos 添加路由配置</h3>
<p>创建 JSON 格式的路由配置（dataId：<code>gateway-routes.json</code>，类型：JSON）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbda70d0a7.png" alt="image"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;item&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/items/**&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_genkey_1&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/search/**&quot;</span><span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://item-service&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cart&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/carts/**&quot;</span><span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://cart-service&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/users/**&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_genkey_1&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/addresses/**&quot;</span><span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://user-service&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;trade&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/orders/**&quot;</span><span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://trade-service&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pay&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;/pay-orders/**&quot;</span><span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://pay-service&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<h3 id="7-4-5-步骤-4：测试动态路由">7.4.5 步骤 4：测试动态路由</h3>
<ol>
<li>
<p><strong>初始测试</strong>：启动网关后，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/search/list%EF%BC%8C%E8%BF%94%E5%9B%9E">http://localhost:8080/search/list，返回</a> 404（无路由配置）；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbdf720fed.png" alt="image"></p>
</li>
<li>
<p><strong>添加 Nacos 配置</strong>：提交<code>gateway-routes.json</code>后，无需重启网关；</p>
</li>
<li>
<p><strong>验证路由</strong>：再次访问同一地址，返回商品列表（路由生效）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/21/68cfbe09b308c.png" alt="image"></p>
</li>
</ol>
<h2 id="7-5-总结">7.5 总结</h2>
<table>
<thead>
<tr>
<th>功能</th>
<th>实现方式</th>
<th>核心组件 / 注解</th>
</tr>
</thead>
<tbody>
<tr>
<td>配置共享</td>
<td>Nacos 集中存储，微服务通过 bootstrap 拉取</td>
<td><code>bootstrap.yaml</code>、<code>shared-configs</code></td>
</tr>
<tr>
<td>配置热更新</td>
<td><code>@ConfigurationProperties</code>绑定配置</td>
<td><code>@ConfigurationProperties</code></td>
</tr>
<tr>
<td>动态路由</td>
<td>监听 Nacos 配置，更新网关路由表</td>
<td><code>NacosConfigManager</code>、<code>RouteDefinitionWriter</code></td>
</tr>
</tbody>
</table>
<p>Nacos 配置中心彻底解决了微服务配置的重复、静态、难维护问题，是微服务架构的核心基础设施之一。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://www.xwybq.top">xw</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.xwybq.top/posts/96a41905/">https://www.xwybq.top/posts/96a41905/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://www.xwybq.top" target="_blank">xw的妙妙屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post-share"><div class="social-share" data-image="https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/566f2e7a/" title="华为OD机试题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/11/30/692bf3754dd03.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">华为OD机试题</div></div><div class="info-2"><div class="info-item-1">华为 OD 机试总结  核心数据 编程语言：Java 总分：300 分（满分400分） 各题得分拆分： 第一题：100 分 ×90% = 90 分 第二题：100 分 ×100% = 100 分 第三题：200 分 ×55% = 110 分 做题情况 考试时有些紧张，部分API回忆耗时些许。 第二题为纯DFS题，脑子抽风了，解题思路卡顿较久。 第三题为抽象数据结构题，我做的时候题目图片无法显示QAQ，需自行绘制逻辑图。  字符串分割 题目描述 给定一个非空字符串S，其被N个‘-’分隔成N+1个子串，给定正整数K，要求除第一个子串外，其余的子串需先合并为一个整体，再按每K个字符组成新的子串，所有新子串之间用‘-’分隔。对于每个新组成的子串，需按以下规则转换大小写：  若子串中小写字母数量 &gt; 大写字母数量：将所有大写字母转换为小写字母； 若子串中大写字母数量 &gt; 小写字母数量：将所有小写字母转换为大写字母； 若大小写字母数量相等：不做转换。 最终将第一个子串与所有转换后的新子串用‘-’连接，输出结果。  输入格式 输入为两行，第一行为正整数K，第二行为非空字符串S。 输...</div></div></div></a><a class="pagination-related" href="/posts/5c266b64/" title="Docker"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/20/68ce3fb79337e.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Docker</div></div><div class="info-2"><div class="info-item-1">前言 在学习 Linux 操作系统和项目部署时，我们常遇到命令繁多、软件安装复杂、环境依赖冲突等问题。尤其在微服务时代，成百上千台服务器的部署运维更是挑战。Docker 技术的出现，通过容器化解决了环境隔离与快速部署的问题，让项目部署变得简单高效。 本文基于 Ubuntu 24.04 LTS 系统，整理 Docker 核心知识点，包括基础命令、数据卷、镜像构建、网络配置及项目部署，并补充实用扩展内容。 1. 快速入门 1.1 安装 Docker Docker 支持主流操作系统，但安装方式因系统而异。以 Ubuntu 24.04 LTS 为例，可直接参考官方安装文档：https://docs.docker.com/engine/install/ubuntu/  按照文档提示逐步执行命令即可，也可参考视频教程操作：https://www.bilibili.com/video/BV183B1Y2EGk/?spm_id_from=333.337.search-card.all.click&amp;vd_source=ffdc8ef30147923fee0d363c8e4b12bb 对于其...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/5c266b64/" title="Docker"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/20/68ce3fb79337e.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-20</div><div class="info-item-2">Docker</div></div><div class="info-2"><div class="info-item-1">前言 在学习 Linux 操作系统和项目部署时，我们常遇到命令繁多、软件安装复杂、环境依赖冲突等问题。尤其在微服务时代，成百上千台服务器的部署运维更是挑战。Docker 技术的出现，通过容器化解决了环境隔离与快速部署的问题，让项目部署变得简单高效。 本文基于 Ubuntu 24.04 LTS 系统，整理 Docker 核心知识点，包括基础命令、数据卷、镜像构建、网络配置及项目部署，并补充实用扩展内容。 1. 快速入门 1.1 安装 Docker Docker 支持主流操作系统，但安装方式因系统而异。以 Ubuntu 24.04 LTS 为例，可直接参考官方安装文档：https://docs.docker.com/engine/install/ubuntu/  按照文档提示逐步执行命令即可，也可参考视频教程操作：https://www.bilibili.com/video/BV183B1Y2EGk/?spm_id_from=333.337.search-card.all.click&amp;vd_source=ffdc8ef30147923fee0d363c8e4b12bb 对于其...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/image/headshot.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">xw</div><div class="author-info-description">白天写BUG，夜里写诗，偶尔人间失焦，却一直在发光。</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xwybq"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/xwybq" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:w3290819205@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p>⚙️ 框架核心：Hexo</p>
<p>🕹️ 界面设计：Butterfly</p>
<p>🔮 域名托管：雨云</p>
<p>🎰 部署平台：GitHub Pages + Vercel</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://blog.liushen.fun/config/img/notice.gif" alt="gif" style="width:100%;border-radius:8px;margin-top:8px;">
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">1. 认识微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-text">1.1 单体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%AF%E7%94%A8%E6%80%A7%E9%97%AE%E9%A2%98%E6%BC%94%E7%A4%BA%EF%BC%88%E4%BB%A5%E9%BB%91%E9%A9%AC%E5%95%86%E5%9F%8E%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">单体架构可用性问题演示（以黑马商城为例）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.2 微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E7%A4%BA%E4%BE%8B%EF%BC%88%E9%BB%91%E9%A9%AC%E5%95%86%E5%9F%8E%EF%BC%89"><span class="toc-text">微服务拆分示例（黑马商城）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AF%B9%E5%8D%95%E4%BD%93%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="toc-text">微服务对单体问题的解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-SpringCloud"><span class="toc-text">1.3 SpringCloud</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringCloud-%E4%B8%8E-SpringBoot-%E7%89%88%E6%9C%AC%E5%AF%B9%E5%BA%94"><span class="toc-text">SpringCloud 与 SpringBoot 版本对应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%B6%E5%B7%A5%E7%A8%8B%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE%EF%BC%88%E9%BB%91%E9%A9%AC%E5%95%86%E5%9F%8E%EF%BC%89"><span class="toc-text">父工程依赖配置（黑马商城）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">2. 微服务拆分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%86%9F%E6%82%89%E9%BB%91%E9%A9%AC%E5%95%86%E5%9F%8E"><span class="toc-text">2.1 熟悉黑马商城</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-%E7%99%BB%E5%BD%95%E4%B8%9A%E5%8A%A1"><span class="toc-text">2.1.1 登录业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-%E6%90%9C%E7%B4%A2%E5%95%86%E5%93%81"><span class="toc-text">2.1.2 搜索商品</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-%E8%B4%AD%E7%89%A9%E8%BD%A6%E4%B8%9A%E5%8A%A1"><span class="toc-text">2.1.3 购物车业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-%E4%B8%8B%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="toc-text">2.1.4 下单业务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1"><span class="toc-text">2.1.5 支付业务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99"><span class="toc-text">2.2 服务拆分原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E6%8B%86"><span class="toc-text">2.2.1 什么时候拆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%80%8E%E4%B9%88%E6%8B%86"><span class="toc-text">2.2.2 怎么拆</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%86%E5%88%86%E6%96%B9%E5%BC%8F"><span class="toc-text">拆分方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%8B%86%E5%88%86%E8%B4%AD%E7%89%A9%E8%BD%A6%E3%80%81%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1"><span class="toc-text">2.3 拆分购物车、商品服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%EF%BC%88item-service%EF%BC%89"><span class="toc-text">2.3.1 商品服务（item-service）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E8%B4%AD%E7%89%A9%E8%BD%A6%E6%9C%8D%E5%8A%A1%EF%BC%88cart-service%EF%BC%89"><span class="toc-text">2.3.2 购物车服务（cart-service）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9C%A8-cart-service-%E4%B8%AD%E6%9F%A5%E8%AF%A2-item-service-%E7%9A%84%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF%EF%BC%9F"><span class="toc-text">问题：如何在 cart-service 中查询 item-service 的商品信息？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-text">2.4 服务调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">2.4.1 远程调用流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%B7%A8%E6%9C%8D%E5%8A%A1-HTTP-%E8%B0%83%E7%94%A8%EF%BC%9F"><span class="toc-text">2.4.2 如何实现跨服务 HTTP 调用？</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-1-RestTemplate%EF%BC%88Spring-HTTP-%E8%AF%B7%E6%B1%82%E5%B7%A5%E5%85%B7%EF%BC%89"><span class="toc-text">2.4.2.1 RestTemplate（Spring HTTP 请求工具）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2-2-%E6%B3%A8%E5%86%8C-RestTemplate-%E4%B8%BA-Spring-Bean"><span class="toc-text">2.4.2.2 注册 RestTemplate 为 Spring Bean</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-3-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%AE%9E%E6%88%98%EF%BC%88%E8%B4%AD%E7%89%A9%E8%BD%A6%E8%B0%83%E7%94%A8%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-text">2.4.3 远程调用实战（购物车调用商品服务）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-4-%E6%B5%8B%E8%AF%95%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-text">2.4.4 测试远程调用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E6%80%BB%E7%BB%93"><span class="toc-text">2.5 总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E6%97%B6%E6%9C%BA"><span class="toc-text">微服务拆分时机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%86%E5%88%86%E5%8E%9F%E5%88%99"><span class="toc-text">微服务拆分原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%88RPC%EF%BC%89"><span class="toc-text">微服务远程调用（RPC）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">3. 服务注册和发现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-text">3.1 注册中心原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Nacos-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-text">3.2 Nacos 注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-%E9%83%A8%E7%BD%B2-Nacos%EF%BC%88%E5%9F%BA%E4%BA%8E-Docker%EF%BC%89"><span class="toc-text">3.2.1 部署 Nacos（基于 Docker）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%EF%BC%88%E4%BB%A5item-service%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">3.3 服务注册（以item-service为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">3.3.1 引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E9%85%8D%E7%BD%AE-Nacos-%E5%9C%B0%E5%9D%80"><span class="toc-text">3.3.2 配置 Nacos 地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-%E5%90%AF%E5%8A%A8%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%B9%B6%E9%AA%8C%E8%AF%81"><span class="toc-text">3.3.3 启动多实例并验证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%EF%BC%88%E4%BB%A5cart-service%E4%B8%BA%E4%BE%8B%EF%BC%89"><span class="toc-text">3.4 服务发现（以cart-service为例）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">3.4.1 引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-2-%E9%85%8D%E7%BD%AE-Nacos-%E5%9C%B0%E5%9D%80"><span class="toc-text">3.4.2 配置 Nacos 地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-4-3-%E5%8F%91%E7%8E%B0%E5%B9%B6%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.4.3 发现并调用服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">4. OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">4.1 快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">4.1.1 引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%90%AF%E7%94%A8-OpenFeign"><span class="toc-text">4.1.2 启用 OpenFeign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E7%BC%96%E5%86%99-Feign-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">4.1.3 编写 Feign 客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E4%BD%BF%E7%94%A8-Feign-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">4.1.4 使用 Feign 客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BC%98%E5%8C%96"><span class="toc-text">4.2 连接池优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BC%95%E5%85%A5-OKHttp-%E4%BE%9D%E8%B5%96"><span class="toc-text">4.2.1 引入 OKHttp 依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%BC%80%E5%90%AF%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-text">4.2.2 开启连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-%E9%AA%8C%E8%AF%81%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%94%9F%E6%95%88"><span class="toc-text">4.2.3 验证连接池生效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%88Feign-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8A%BD%E5%8F%96%EF%BC%89"><span class="toc-text">4.3 最佳实践（Feign 客户端抽取）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-text">4.3.1 思路分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%88%9B%E5%BB%BA%E5%85%AC%E5%85%B1-API-%E6%A8%A1%E5%9D%97%EF%BC%88hm-api%EF%BC%89"><span class="toc-text">4.3.2 创建公共 API 模块（hm-api）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E6%9C%8D%E5%8A%A1%E5%BC%95%E5%85%A5%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97"><span class="toc-text">4.3.3 服务引入公共模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-text">4.4 日志配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-Feign-%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-text">4.4.1 Feign 日志级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E7%BA%A7%E5%88%AB"><span class="toc-text">4.4.2 配置日志级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-3-%E6%97%A5%E5%BF%97%E7%A4%BA%E4%BE%8B%EF%BC%88FULL-%E7%BA%A7%E5%88%AB%EF%BC%89"><span class="toc-text">4.4.3 日志示例（FULL 级别）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">5. 网关路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%AE%A4%E8%AF%86%E7%BD%91%E5%85%B3"><span class="toc-text">5.1 认识网关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-%E7%BD%91%E5%85%B3%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E4%BD%9C%E7%94%A8"><span class="toc-text">5.1.1 网关的定义与作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-SpringCloud-%E4%B8%AD%E7%9A%84%E7%BD%91%E5%85%B3%E6%96%B9%E6%A1%88"><span class="toc-text">5.1.2 SpringCloud 中的网关方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%EF%BC%9A%E5%AE%9E%E7%8E%B0%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1"><span class="toc-text">5.2 快速入门：实现网关路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%88%9B%E5%BB%BA%E7%BD%91%E5%85%B3%E6%A8%A1%E5%9D%97%EF%BC%88hm-gateway%EF%BC%89"><span class="toc-text">5.2.1 步骤 1：创建网关模块（hm-gateway）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%BC%95%E5%85%A5%E6%A0%B8%E5%BF%83%E4%BE%9D%E8%B5%96"><span class="toc-text">5.2.2 步骤 2：引入核心依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E7%BC%96%E5%86%99%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-text">5.2.3 步骤 3：编写启动类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-4-%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E9%85%8D%E7%BD%AE%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-text">5.2.4 步骤 4：配置路由规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-5-%E6%AD%A5%E9%AA%A4-5%EF%BC%9A%E6%B5%8B%E8%AF%95%E8%B7%AF%E7%94%B1%E5%8A%9F%E8%83%BD"><span class="toc-text">5.2.5 步骤 5：测试路由功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E4%B8%8E%E6%96%AD%E8%A8%80%E8%AF%A6%E8%A7%A3"><span class="toc-text">5.3 路由规则与断言详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E6%A0%B8%E5%BF%83%E7%BB%93%E6%9E%84"><span class="toc-text">5.3.1 路由规则核心结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E5%B8%B8%E7%94%A8%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E7%B1%BB%E5%9E%8B"><span class="toc-text">5.3.2 常用路由断言类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-%E6%96%AD%E8%A8%80%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-text">5.3.3 断言组合使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">6. 网关登录校验</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E9%89%B4%E6%9D%83%E6%80%9D%E8%B7%AF%E5%88%86%E6%9E%90"><span class="toc-text">6.1 鉴权思路分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E6%A0%B8%E5%BF%83%E7%97%9B%E7%82%B9"><span class="toc-text">6.1.1 核心痛点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E7%BD%91%E5%85%B3%E7%BB%9F%E4%B8%80%E9%89%B4%E6%9D%83%E6%96%B9%E6%A1%88"><span class="toc-text">6.1.2 网关统一鉴权方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E5%BE%85%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-text">6.1.3 待解决问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8%EF%BC%9A%E9%89%B4%E6%9D%83%E7%9A%84%E6%8A%80%E6%9C%AF%E5%9F%BA%E7%A1%80"><span class="toc-text">6.2 网关过滤器：鉴权的技术基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-Gateway-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">6.2.1 Gateway 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-text">6.2.2 网关过滤器类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-%E5%86%85%E7%BD%AE-GatewayFilter-%E4%BD%BF%E7%94%A8"><span class="toc-text">6.2.3 内置 GatewayFilter 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%B7%BB%E5%8A%A0%E8%AF%B7%E6%B1%82%E5%A4%B4%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">示例：添加请求头过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">6.3 自定义过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-1-%E8%87%AA%E5%AE%9A%E4%B9%89-GatewayFilter"><span class="toc-text">6.3.1 自定义 GatewayFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1%EF%BC%9A%E5%9F%BA%E7%A1%80%E6%97%A0%E5%8F%82%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">示例 1：基础无参过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-2%EF%BC%9A%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">示例 2：带参数的过滤器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-2-%E8%87%AA%E5%AE%9A%E4%B9%89-GlobalFilter"><span class="toc-text">6.3.2 自定义 GlobalFilter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E7%AE%80%E5%8D%95%E6%8B%A6%E6%88%AA%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">示例：简单拦截过滤器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E5%AE%9E%E6%88%98%EF%BC%9A%E7%BD%91%E5%85%B3%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%EF%BC%88%E5%9F%BA%E4%BA%8E-JWT%EF%BC%89"><span class="toc-text">6.4 实战：网关登录校验（基于 JWT）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-1-%E5%87%86%E5%A4%87-JWT-%E5%B7%A5%E5%85%B7"><span class="toc-text">6.4.1 准备 JWT 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-2-%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%A0%A1%E9%AA%8C%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">6.4.2 实现登录校验过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-3-%E6%B5%8B%E8%AF%95%E9%89%B4%E6%9D%83%E6%95%88%E6%9E%9C"><span class="toc-text">6.4.3 测试鉴权效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">6.5 微服务获取用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1-%E7%BD%91%E5%85%B3%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">6.5.1 网关传递用户信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#image6-5-2-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%A6%E6%88%AA%E5%99%A8%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7"><span class="toc-text">6.5.2 微服务拦截器获取用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9AThreadLocal-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">步骤 1：ThreadLocal 工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">步骤 2：实现拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">步骤 3：自动装配拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-text">步骤 4：配置自动装配</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3-%E6%81%A2%E5%A4%8D%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-text">6.5.3 恢复业务代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-OpenFeign-%E4%BC%A0%E9%80%92%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-text">6.6 OpenFeign 传递用户信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1-%E5%AE%9E%E7%8E%B0-Feign-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">6.6.1 实现 Feign 拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-2-%E6%B5%8B%E8%AF%95%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8"><span class="toc-text">6.6.2 测试微服务间调用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text">7. 配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-text">7.1 配置管理概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-1-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E7%9A%84%E6%A0%B8%E5%BF%83%E7%97%9B%E7%82%B9"><span class="toc-text">7.1.1 微服务配置的核心痛点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-2-Nacos-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">7.1.2 Nacos 配置中心解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-%E9%85%8D%E7%BD%AE%E5%85%B1%E4%BA%AB%EF%BC%9A%E6%B6%88%E9%99%A4%E9%87%8D%E5%A4%8D%E9%85%8D%E7%BD%AE"><span class="toc-text">7.2 配置共享：消除重复配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-1-%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%9C%A8-Nacos-%E6%B7%BB%E5%8A%A0%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-text">7.2.1 步骤 1：在 Nacos 添加共享配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE%EF%BC%88dataId%EF%BC%9Ashared-jdbc-yaml%EF%BC%89"><span class="toc-text">1. 共享数据库配置（dataId：shared-jdbc.yaml）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%85%B1%E4%BA%AB%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%EF%BC%88dataId%EF%BC%9Ashared-log-yaml%EF%BC%89"><span class="toc-text">2. 共享日志配置（dataId：shared-log.yaml）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%B1%E4%BA%AB-Swagger-%E9%85%8D%E7%BD%AE%EF%BC%88dataId%EF%BC%9Ashared-swagger-yaml%EF%BC%89"><span class="toc-text">3. 共享 Swagger 配置（dataId：shared-swagger.yaml）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-2-%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8B%89%E5%8F%96%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE"><span class="toc-text">7.2.2 步骤 2：微服务拉取共享配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1. 引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-bootstrap-yaml"><span class="toc-text">2. 创建 bootstrap.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%AE%80%E5%8C%96%E6%9C%AC%E5%9C%B0-application-yaml"><span class="toc-text">3. 简化本地 application.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C"><span class="toc-text">4. 验证效果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-3-%E5%85%B3%E9%94%AE%E5%8E%9F%E7%90%86%EF%BC%9A%E9%85%8D%E7%BD%AE%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F"><span class="toc-text">7.2.3 关键原理：配置加载顺序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0%EF%BC%9A%E6%97%A0%E9%9C%80%E9%87%8D%E5%90%AF%E7%94%9F%E6%95%88"><span class="toc-text">7.3 配置热更新：无需重启生效</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-1-%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%9C%A8-Nacos-%E6%B7%BB%E5%8A%A0%E7%83%AD%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">7.3.1 步骤 1：在 Nacos 添加热更新配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-2-%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AF%BB%E5%8F%96%E7%83%AD%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE"><span class="toc-text">7.3.2 步骤 2：微服务读取热更新配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E7%BB%91%E5%AE%9A%E7%B1%BB"><span class="toc-text">1. 创建配置绑定类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%9A%E5%8A%A1%E4%B8%AD%E4%BD%BF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">2. 业务中使用配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-3-%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E6%B5%8B%E8%AF%95%E7%83%AD%E6%9B%B4%E6%96%B0%E6%95%88%E6%9E%9C"><span class="toc-text">7.3.3 步骤 3：测试热更新效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%EF%BC%9A%E7%BD%91%E5%85%B3%E8%B7%AF%E7%94%B1%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="toc-text">7.4 动态路由：网关路由热更新</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E6%A0%B8%E5%BF%83%E9%9A%BE%E7%82%B9%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">7.4.1 核心难点与解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2-%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E7%BD%91%E5%85%B3%E6%95%B4%E5%90%88-Nacos-%E9%85%8D%E7%BD%AE"><span class="toc-text">7.4.2 步骤 1：网关整合 Nacos 配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96-2"><span class="toc-text">1. 引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE-bootstrap-yaml"><span class="toc-text">2. 配置 bootstrap.yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%AE%80%E5%8C%96-application-yaml"><span class="toc-text">3. 简化 application.yaml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3-%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">7.4.3 步骤 2：实现动态路由加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%BB%A3%E7%A0%81"><span class="toc-text">1. 动态路由加载器代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-4-%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E5%9C%A8-Nacos-%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE"><span class="toc-text">7.4.4 步骤 3：在 Nacos 添加路由配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-5-%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E6%B5%8B%E8%AF%95%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1"><span class="toc-text">7.4.5 步骤 4：测试动态路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-%E6%80%BB%E7%BB%93"><span class="toc-text">7.5 总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/f8e09374/" title="Vue2+3"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/12/26/694e5f1f9bde5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Vue2+3"/></a><div class="content"><a class="title" href="/posts/f8e09374/" title="Vue2+3">Vue2+3</a><time datetime="2025-12-26T08:48:20.000Z" title="发表于 2025-12-26 16:48:20">2025-12-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/566f2e7a/" title="华为OD机试题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/11/30/692bf3754dd03.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="华为OD机试题"/></a><div class="content"><a class="title" href="/posts/566f2e7a/" title="华为OD机试题">华为OD机试题</a><time datetime="2025-11-30T07:25:24.000Z" title="发表于 2025-11-30 15:25:24">2025-11-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/96a41905/" title="SpringCloud"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/22/68d0d3997e0e5.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SpringCloud"/></a><div class="content"><a class="title" href="/posts/96a41905/" title="SpringCloud">SpringCloud</a><time datetime="2025-09-21T02:59:21.000Z" title="发表于 2025-09-21 10:59:21">2025-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5c266b64/" title="Docker"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/20/68ce3fb79337e.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Docker"/></a><div class="content"><a class="title" href="/posts/5c266b64/" title="Docker">Docker</a><time datetime="2025-09-20T04:06:42.000Z" title="发表于 2025-09-20 12:06:42">2025-09-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/67c8035e/" title="MyBatis-Plus"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://a1.boltp.com/2025/09/20/68ce408b0f530.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MyBatis-Plus"/></a><div class="content"><a class="title" href="/posts/67c8035e/" title="MyBatis-Plus">MyBatis-Plus</a><time datetime="2025-09-19T07:31:42.000Z" title="发表于 2025-09-19 15:31:42">2025-09-19</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By xw</span></div><div class="footer_custom_text"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://haiyong.site/img/icp.png"><a href="https://beian.miit.gov.cn/#/Integrated/index" style="color:black" target="_blank">豫ICP备147号-1</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"COMMENT_PLACEHOLDER":"来留下你的精彩评论吧！输入 QQ 号还能自动显示邮箱和头像哦～"}

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.xwybq.top',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo.xwybq.top',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script src="/js/weather.js"></script><script src="/styles/fish.js"></script><script type="text/javascript" src="/js/daliyuer.js"></script><div class="aplayer no-destroy" data-id="732801999" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="list" data-preload="none" data-autoplay="false" muted></div><script src="/js/beauty.js"></script><script src="/js/canvas-nest.js"></script><script src="/js/foot.js"></script><script src="/js/happy-title.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      const usePjax = true
      false
        ? (usePjax ? pjax.loadUrl('/404.html') : window.location.href = '/404.html')
        : window.location.href = e.request.responseURL
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="请输入内容" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1500ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1500ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('container');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1500ms');
    arr[i].setAttribute('data-wow-delay', '0ms');
    arr[i].setAttribute('data-wow-offset', '0');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":130,"height":270,"hOffset":40,"vOffset":-40},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>